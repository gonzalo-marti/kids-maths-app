<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maths Adventure - Learn &amp; Practice</title>
    <style>
        /* Design System CSS */
        :root {
            /* Primitive Color Tokens */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-teal-800: rgba(41, 150, 161, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);

            /* RGB versions for opacity control */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;
            --color-orange-500-rgb: 168, 75, 47;
            --color-orange-400-rgb: 230, 129, 97;

            /* Background color tokens */
            --color-bg-1: rgba(59, 130, 246, 0.08);
            --color-bg-2: rgba(245, 158, 11, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);
            --color-bg-4: rgba(239, 68, 68, 0.08);
            --color-bg-5: rgba(147, 51, 234, 0.08);
            --color-bg-6: rgba(249, 115, 22, 0.08);
            --color-bg-7: rgba(236, 72, 153, 0.08);
            --color-bg-8: rgba(6, 182, 212, 0.08);

            /* Semantic Color Tokens */
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
            --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);
            --color-warning: var(--color-orange-500);
            --color-info: var(--color-slate-500);
            --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

            /* Custom colors for the app */
            --app-primary: #4A90E2;
            --app-secondary: #7B68EE;
            --app-success: #50C878;
            --app-error: #FF6B6B;
            --app-warning: #FFB347;

            /* Typography */
            --font-family-heading: "Comic Sans MS", cursive, var(--font-family-base);
            --font-family-base: "Arial", sans-serif;
            --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            --font-size-xs: 11px;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-md: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            --font-size-2xl: 24px;
            --font-size-3xl: 28px;
            --font-size-4xl: 36px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 550;
            --font-weight-bold: 600;
            --line-height-tight: 1.2;
            --line-height-normal: 1.5;
            --letter-spacing-tight: -0.01em;

            /* Spacing */
            --space-0: 0;
            --space-1: 1px;
            --space-2: 2px;
            --space-4: 4px;
            --space-6: 6px;
            --space-8: 8px;
            --space-10: 10px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;
            --space-48: 48px;
            --space-64: 64px;

            /* Border Radius */
            --radius-sm: 6px;
            --radius-base: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;

            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);
            --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15), inset 0 -1px 0 rgba(0, 0, 0, 0.03);

            /* Animation */
            --duration-fast: 150ms;
            --duration-normal: 250ms;
            --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text);
        }

        .app-container {
            width: 100%;
            max-width: 800px;
            margin: var(--space-20);
        }

        .screen {
            display: none;
            background: var(--color-surface);
            border-radius: var(--radius-xl);
            padding: var(--space-32);
            box-shadow: var(--shadow-lg);
            text-align: center;
            animation: fadeIn 0.3s ease-in;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-family: var(--font-family-heading);
            font-size: var(--font-size-4xl);
            color: var(--app-primary);
            margin-bottom: var(--space-16);
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        h2 {
            font-family: var(--font-family-heading);
            font-size: var(--font-size-3xl);
            color: var(--app-secondary);
            margin-bottom: var(--space-24);
        }

        h3 {
            font-family: var(--font-family-heading);
            font-size: var(--font-size-2xl);
            color: var(--color-text);
            margin-bottom: var(--space-16);
        }

        .subtitle {
            font-size: var(--font-size-lg);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-32);
        }

        .mode-buttons {
            display: flex;
            gap: var(--space-24);
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: var(--space-32);
        }

        .mode-button {
            background: linear-gradient(135deg, var(--app-primary), var(--app-secondary));
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            padding: var(--space-24) var(--space-32);
            font-size: var(--font-size-xl);
            font-family: var(--font-family-heading);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            box-shadow: var(--shadow-md);
            min-width: 200px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-8);
        }

        .mode-button:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .mode-button:active {
            transform: translateY(-2px);
        }

        .mode-icon {
            font-size: var(--font-size-4xl);
        }

        .mode-description {
            font-size: var(--font-size-sm);
            opacity: 0.9;
            font-family: var(--font-family-base);
        }

        .question-container {
            background: var(--color-bg-1);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            margin-bottom: var(--space-24);
            border: 2px solid var(--color-border);
        }

        .question-text {
            font-size: var(--font-size-xl);
            line-height: var(--line-height-normal);
            margin-bottom: var(--space-24);
            color: var(--color-text);
        }

        .answer-input {
            width: 100%;
            max-width: 300px;
            padding: var(--space-12) var(--space-16);
            font-size: var(--font-size-lg);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
            text-align: center;
            background: var(--color-surface);
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--app-primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }

        .button-group {
            display: flex;
            gap: var(--space-12);
            justify-content: center;
            flex-wrap: wrap;
            margin: var(--space-16) 0;
        }

        .btn {
            padding: var(--space-12) var(--space-24);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            min-height: 44px;
            min-width: 120px;
        }

        .btn-primary {
            background: var(--app-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-primary:disabled {
            background: var(--color-gray-400);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-secondary-hover);
        }

        .btn-hint {
            background: var(--app-warning);
            color: white;
        }

        .btn-hint:hover {
            background: #E69A2E;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-24);
            padding: var(--space-16);
            background: var(--color-bg-2);
            border-radius: var(--radius-base);
            flex-wrap: wrap;
            gap: var(--space-16);
        }

        .timer {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--app-primary);
        }

        .timer.warning {
            color: var(--app-warning);
        }

        .timer.danger {
            color: var(--app-error);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .score {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
        }

        .question-number {
            font-size: var(--font-size-lg);
            color: var(--color-text-secondary);
        }

        .feedback {
            margin: var(--space-16) 0;
            padding: var(--space-16);
            border-radius: var(--radius-base);
            font-size: var(--font-size-md);
            font-weight: var(--font-weight-medium);
        }

        .feedback.correct {
            background: rgba(80, 200, 120, 0.1);
            color: var(--app-success);
            border: 2px solid var(--app-success);
        }

        .feedback.incorrect {
            background: rgba(255, 107, 107, 0.1);
            color: var(--app-error);
            border: 2px solid var(--app-error);
        }

        .hint {
            background: rgba(255, 179, 71, 0.1);
            border: 2px solid var(--app-warning);
            color: #B8860B;
            padding: var(--space-16);
            border-radius: var(--radius-base);
            margin: var(--space-16) 0;
            font-style: italic;
        }

        .explanation {
            background: var(--color-bg-3);
            border: 2px solid var(--color-border);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            margin: var(--space-16) 0;
            text-align: left;
        }

        .explanation h4 {
            color: var(--app-primary);
            margin-bottom: var(--space-8);
            font-family: var(--font-family-heading);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-16);
            margin: var(--space-24) 0;
        }

        .stat-item {
            background: var(--color-bg-1);
            padding: var(--space-16);
            border-radius: var(--radius-base);
            text-align: center;
        }

        .stat-value {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-bold);
            color: var(--app-primary);
            display: block;
        }

        .stat-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-top: var(--space-4);
        }

        .celebration {
            font-size: var(--font-size-4xl);
            margin: var(--space-16) 0;
        }

        /* User Selection & Dashboard Styles */
        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-32);
        }

        .user-card {
            background: var(--color-bg-1);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            text-align: center;
        }

        .user-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--app-primary);
        }

        .user-card.selected {
            border-color: var(--app-primary);
            background: var(--color-bg-3);
        }

        .user-card-avatar {
            font-size: var(--font-size-4xl);
            margin-bottom: var(--space-12);
        }

        .user-card-name {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
            margin-bottom: var(--space-8);
        }

        .user-card-stats {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            line-height: 1.4;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--space-8);
            margin-bottom: var(--space-16);
        }

        .avatar-btn {
            background: var(--color-secondary);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-12);
            font-size: var(--font-size-2xl);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
        }

        .avatar-btn:hover {
            transform: scale(1.1);
            border-color: var(--app-primary);
        }

        .avatar-btn.selected {
            background: var(--app-primary);
            border-color: var(--app-primary);
            transform: scale(1.1);
        }

        .current-user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-16);
            background: var(--color-bg-1);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            margin-bottom: var(--space-32);
        }

        .user-avatar {
            font-size: var(--font-size-3xl);
        }

        .user-name {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
        }

        .dashboard-header {
            display: flex;
            align-items: center;
            gap: var(--space-20);
            margin-bottom: var(--space-32);
            padding: var(--space-24);
            background: var(--color-bg-1);
            border-radius: var(--radius-lg);
        }

        .dashboard-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            margin-bottom: var(--space-24);
        }

        .dashboard-section h3 {
            color: var(--app-primary);
            margin-bottom: var(--space-16);
            font-family: var(--font-family-heading);
        }

        .category-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-12);
        }

        .category-item {
            background: var(--color-bg-2);
            border-radius: var(--radius-base);
            padding: var(--space-12);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-name {
            font-weight: var(--font-weight-medium);
            color: var(--color-text);
        }

        .category-score {
            font-weight: var(--font-weight-bold);
        }

        .category-score.excellent { color: var(--app-success); }
        .category-score.good { color: var(--app-warning); }
        .category-score.needs-work { color: var(--app-error); }

        .session-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .session-item {
            background: var(--color-bg-3);
            border-radius: var(--radius-base);
            padding: var(--space-12);
            margin-bottom: var(--space-8);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .session-info {
            color: var(--color-text);
        }

        .session-stats {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .mistake-review {
            text-align: center;
        }

        .mistake-stats {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-16);
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: var(--space-12);
        }

        .achievement-item {
            background: var(--color-bg-4);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            text-align: center;
            transition: all var(--duration-normal) var(--ease-standard);
        }

        .achievement-item.unlocked {
            background: var(--color-bg-3);
            border: 2px solid var(--app-success);
            box-shadow: 0 0 10px rgba(80, 200, 120, 0.3);
        }

        .achievement-icon {
            font-size: var(--font-size-3xl);
            margin-bottom: var(--space-8);
        }

        .achievement-name {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
            margin-bottom: var(--space-4);
        }

        .achievement-desc {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .mistakes-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .mistake-item {
            background: var(--color-bg-4);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            margin-bottom: var(--space-12);
            border-left: 4px solid var(--app-error);
        }

        .mistake-question {
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
            margin-bottom: var(--space-8);
        }

        .mistake-details {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .parent-user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-20);
            margin-bottom: var(--space-32);
        }
        
        /* Modal Styles - CRITICAL FIX FOR USER CREATION */
        .modal {
            display: none !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            background: rgba(0, 0, 0, 0.7) !important;
            z-index: 999999 !important;
            justify-content: center !important;
            align-items: center !important;
        }
        
        .modal.visible {
            display: flex !important;
        }
        
        /* Ensure modal content is always on top */
        .modal-content {
            position: relative !important;
            z-index: 1000000 !important;
        }
        
        .modal-content {
            background: var(--color-surface);
            padding: var(--space-32);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            max-width: 500px;
            width: 90%;
            z-index: 10001;
            position: relative;
        }
        
        .avatar-selection {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-8);
            margin-bottom: var(--space-16);
        }
        
        .avatar-option {
            background: var(--color-secondary);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-12);
            font-size: var(--font-size-2xl);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .avatar-option:hover {
            transform: scale(1.1);
            border-color: var(--app-primary);
            background: var(--color-secondary-hover);
        }
        
        .avatar-option.selected {
            background: var(--app-primary);
            color: white;
            border-color: var(--app-primary);
            transform: scale(1.1);
        }
        
        .error-message {
            color: var(--color-error);
            font-size: var(--font-size-sm);
            margin-top: var(--space-4);
            padding: var(--space-8);
            background: rgba(var(--color-error-rgb), 0.1);
            border-radius: var(--radius-sm);
            border: 1px solid rgba(var(--color-error-rgb), 0.3);
        }
        
        .time-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: var(--space-24);
        }
        
        .time-table th,
        .time-table td {
            padding: var(--space-12);
            border: 1px solid var(--color-border);
            text-align: left;
        }
        
        .time-table th {
            background: var(--color-bg-1);
            font-weight: var(--font-weight-bold);
            text-align: center;
        }
        
        .time-table tbody tr:nth-child(even) {
            background: var(--color-bg-2);
        }
        
        .password-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .parent-user-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-20);
        }
        
        /* Leaderboard Styles */
        .leaderboard-tabs {
            display: flex;
            gap: var(--space-4);
            margin-bottom: var(--space-24);
            overflow-x: auto;
            padding: var(--space-4);
            background: var(--color-bg-1);
            border-radius: var(--radius-lg);
        }
        
        .tab-btn {
            padding: var(--space-8) var(--space-12);
            border: 2px solid transparent;
            background: var(--color-secondary);
            color: var(--color-text);
            border-radius: var(--radius-base);
            cursor: pointer;
            transition: all var(--duration-normal) var(--ease-standard);
            font-size: var(--font-size-sm);
            white-space: nowrap;
            min-width: 80px;
        }
        
        .tab-btn:hover {
            background: var(--color-secondary-hover);
        }
        
        .tab-btn.active {
            background: var(--app-primary);
            color: white;
            border-color: var(--app-primary);
        }
        
        .leaderboard-table {
            width: 100%;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-16);
        }
        
        .leaderboard-header {
            background: var(--color-bg-1);
            padding: var(--space-12);
            display: grid;
            grid-template-columns: 60px 1fr auto auto;
            gap: var(--space-12);
            align-items: center;
            font-weight: var(--font-weight-bold);
            border-bottom: 2px solid var(--color-border);
        }
        
        .leaderboard-row {
            padding: var(--space-12);
            display: grid;
            grid-template-columns: 60px 1fr auto auto;
            gap: var(--space-12);
            align-items: center;
            border-bottom: 1px solid var(--color-card-border);
            transition: background var(--duration-normal) var(--ease-standard);
        }
        
        .leaderboard-row:hover {
            background: var(--color-bg-2);
        }
        
        .leaderboard-row.current-user {
            background: var(--color-bg-3);
            border: 2px solid var(--app-primary);
            border-radius: var(--radius-base);
            margin: var(--space-4) 0;
        }
        
        .rank-display {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            text-align: center;
        }
        
        .rank-1 { color: #FFD700; }
        .rank-2 { color: #C0C0C0; }
        .rank-3 { color: #CD7F32; }
        .rank-other { color: var(--color-text-secondary); }
        
        .player-info {
            display: flex;
            align-items: center;
            gap: var(--space-8);
        }
        
        .player-avatar {
            font-size: var(--font-size-xl);
        }
        
        .player-name {
            font-weight: var(--font-weight-medium);
            color: var(--color-text);
        }
        
        .player-stats {
            text-align: right;
            font-weight: var(--font-weight-bold);
            color: var(--app-primary);
        }
        
        .progress-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }
        
        .rank-change {
            font-size: var(--font-size-sm);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-sm);
        }
        
        .rank-up {
            background: rgba(80, 200, 120, 0.1);
            color: var(--app-success);
        }
        
        .rank-down {
            background: rgba(255, 107, 107, 0.1);
            color: var(--app-error);
        }
        
        .rank-same {
            background: var(--color-secondary);
            color: var(--color-text-secondary);
        }
        
        .rank-new {
            background: var(--color-bg-1);
            color: var(--app-primary);
        }
        
        .next-rank-info {
            background: var(--color-bg-3);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            margin: var(--space-16) 0;
            text-align: center;
        }
        
        .motivational-message {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            color: var(--app-primary);
            text-align: center;
            margin: var(--space-16) 0;
            padding: var(--space-12);
            background: var(--color-bg-1);
            border-radius: var(--radius-base);
        }
        
        .points-earned {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--app-success);
            color: white;
            padding: var(--space-8) var(--space-16);
            border-radius: var(--radius-full);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-lg);
            animation: pointsEarned 2s ease-out forwards;
            z-index: 1000;
            pointer-events: none;
        }
        
        @keyframes pointsEarned {
            0% {
                opacity: 0;
                transform: translateY(-20px) scale(0.8);
            }
            20% {
                opacity: 1;
                transform: translateY(0) scale(1.1);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px) scale(1);
            }
        }
        
        .category-champions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
        }
        
        .champion-card {
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-16);
            text-align: center;
        }
        
        .champion-category {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-8);
        }
        
        .champion-player {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-8);
            margin-bottom: var(--space-8);
        }
        
        .champion-stats {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .parent-user-header {
            display: flex;
            align-items: center;
            gap: var(--space-12);
            margin-bottom: var(--space-16);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--color-secondary);
            border-radius: var(--radius-full);
            overflow: hidden;
            margin: var(--space-8) 0;
        }

        .progress-fill {
            height: 100%;
            background: var(--app-success);
            transition: width var(--duration-normal) var(--ease-standard);
        }

        @media (max-width: 768px) {
            .leaderboard-tabs {
                flex-wrap: wrap;
            }
            
            .leaderboard-header,
            .leaderboard-row {
                grid-template-columns: 40px 1fr auto;
                gap: var(--space-8);
            }
            
            .progress-indicator {
                display: none;
            }
            
            .category-champions {
                grid-template-columns: 1fr;
            }
            
            .tab-btn {
                min-width: 60px;
                font-size: var(--font-size-xs);
            }
            
            .app-container {
                margin: var(--space-12);
            }
            
            .screen {
                padding: var(--space-24);
            }
            
            h1 {
                font-size: var(--font-size-3xl);
            }
            
            .mode-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .mode-button {
                min-width: 250px;
            }
            
            .progress-info {
                flex-direction: column;
                text-align: center;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .user-list {
                grid-template-columns: 1fr;
            }

            .avatar-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .category-stats {
                grid-template-columns: 1fr;
            }

            .achievements-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .parent-user-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- User Selection Screen -->
        <div class="screen active" id="user-screen">
            <h1>üßÆ Maths Adventure üåü</h1>
            <p class="subtitle">Choose your profile to continue your learning journey!</p>
            
            <div id="user-list" class="user-list">
                <!-- Users will be populated here -->
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" id="createNewUserBtn">‚ûï Create New User</button>
                <button class="btn btn-secondary" onclick="requestParentAccess()">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent View</button>
            </div>
        </div>

        <!-- Create User Modal -->
        <div id="createUserModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2>Create New User</h2>
                <div class="form-group">
                    <label class="form-label" for="newUsername">Username:</label>
                    <input type="text" class="form-control" id="newUsername" placeholder="Enter your name" maxlength="20">
                    <div id="username-error" class="error-message" style="display: none;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Choose your avatar:</label>
                    <div class="avatar-selection">
                        <div class="avatar-option" data-emoji="üöÄ">üöÄ</div>
                        <div class="avatar-option" data-emoji="‚öΩ">‚öΩ</div>
                        <div class="avatar-option" data-emoji="üé®">üé®</div>
                        <div class="avatar-option" data-emoji="üåü">üåü</div>
                        <div class="avatar-option" data-emoji="üéÆ">üéÆ</div>
                        <div class="avatar-option" data-emoji="ü¶Ñ">ü¶Ñ</div>
                        <div class="avatar-option" data-emoji="üåà">üåà</div>
                        <div class="avatar-option" data-emoji="üéØ">üéØ</div>
                        <div class="avatar-option" data-emoji="‚≠ê">‚≠ê</div>
                        <div class="avatar-option" data-emoji="üî•">üî•</div>
                        <div class="avatar-option" data-emoji="üí´">üí´</div>
                        <div class="avatar-option" data-emoji="üé™">üé™</div>
                        <div class="avatar-option" data-emoji="üé≠">üé≠</div>
                        <div class="avatar-option" data-emoji="üé¨">üé¨</div>
                        <div class="avatar-option" data-emoji="üé§">üé§</div>
                        <div class="avatar-option" data-emoji="üèÄ">üèÄ</div>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" id="confirmCreateUser">Create</button>
                    <button class="btn btn-secondary" id="cancelCreateUser">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Welcome Screen -->
        <div class="screen" id="welcome-screen">
            <h1>üßÆ Maths Adventure üåü</h1>
            <p class="subtitle">Choose your learning adventure and improve your maths skills!</p>
            
            <div class="mode-buttons">
                <button class="mode-button" onclick="startMode('practice')">
                    <div class="mode-icon">üìö</div>
                    <div>Practice Mode</div>
                    <div class="mode-description">Practice at your own pace with no time pressure</div>
                </button>
                
                <button class="mode-button" onclick="startMode('challenge')">
                    <div class="mode-icon">‚è∞</div>
                    <div>Challenge Mode</div>
                    <div class="mode-description">Test yourself with 15 questions in 20 minutes</div>
                </button>
                
                <button class="mode-button" onclick="showLeaderboard()">
                    <div class="mode-icon">üèÜ</div>
                    <div>Leaderboard</div>
                    <div class="mode-description">See rankings &amp; compete with friends!</div>
                </button>
            </div>
            
            <div class="current-user-info">
                <div class="user-avatar" id="current-user-avatar">üöÄ</div>
                <div>
                    <div class="user-name" id="current-user-name">Loading...</div>
                    <div id="user-rank-display" style="font-size: var(--font-size-sm); color: var(--color-text-secondary);"></div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-secondary" onclick="showDashboard()">üìä View My Progress</button>
                <button class="btn btn-secondary" onclick="showUserScreen()">üë§ Switch User</button>
                <button class="btn btn-secondary" onclick="showBestScores()">üèÜ View Best Scores</button>
            </div>
            
            <div class="button-group" style="margin-top: var(--space-16);">
                <button class="btn btn-secondary" onclick="requestParentAccess()" style="font-size: var(--font-size-sm); padding: var(--space-6) var(--space-12);">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent View</button>
            </div>
        </div>

        <!-- Question Screen -->
        <div class="screen" id="question-screen">
            <div class="progress-info">
                <div class="question-number" id="question-counter">Question 1</div>
                <div class="score" id="score-display">Score: 0/0 (0%)</div>
                <div class="timer" id="timer-display"></div>
            </div>
            
            <div class="question-container">
                <div class="question-text" id="question-text">Loading question...</div>
                
                <input type="text" class="answer-input" id="answer-input" placeholder="Type your answer here..." onkeypress="handleKeyPress(event)">
                
                <div class="button-group">
                    <button class="btn btn-hint" id="hint-btn" onclick="showHint()">üí° Hint</button>
                    <button class="btn btn-primary" id="submit-btn" onclick="submitAnswer()" disabled>Submit Answer</button>
                </div>
                
                <div id="hint-container"></div>
                <div id="feedback-container"></div>
                <div id="explanation-container"></div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-secondary" onclick="showPauseMenu()">‚è∏Ô∏è Pause</button>
                <button class="btn btn-secondary" onclick="confirmQuit()">üè† Back to Menu</button>
                <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()" style="display: none;">Next Question ‚û°Ô∏è</button>
                <button class="btn btn-primary" id="finish-btn" onclick="finishSession()" style="display: none;">Finish Session</button>
            </div>
            
            <div style="margin-top: var(--space-16); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                <span id="hints-used">Hints used: 0</span>
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div class="screen" id="dashboard-screen">
            <div class="dashboard-header">
                <div class="user-avatar" id="dash-user-avatar">üöÄ</div>
                <div>
                    <h2 id="dash-user-name">User Dashboard</h2>
                    <p class="subtitle">Track your amazing progress!</p>
                </div>
            </div>
            
            <div class="dashboard-content">
                <!-- Overall Statistics -->
                <div class="dashboard-section">
                    <h3>üìä Overall Statistics</h3>
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-value" id="dash-total-questions">0</span>
                            <div class="stat-label">Questions Attempted</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="dash-accuracy">0%</span>
                            <div class="stat-label">Overall Accuracy</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="dash-hints-used">0</span>
                            <div class="stat-label">Hints Used</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="dash-time-practiced">0m</span>
                            <div class="stat-label">Time Practiced</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="dash-streak">0</span>
                            <div class="stat-label">Day Streak</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="dash-achievements">0</span>
                            <div class="stat-label">Achievements</div>
                        </div>
                    </div>
                </div>

                <!-- Category Performance -->
                <div class="dashboard-section">
                    <h3>üìà Performance by Category</h3>
                    <div id="category-performance" class="category-stats">
                        <!-- Categories will be populated here -->
                    </div>
                </div>

                <!-- Recent Sessions -->
                <div class="dashboard-section">
                    <h3>üìÖ Recent Sessions</h3>
                    <div id="recent-sessions" class="session-list">
                        <!-- Sessions will be populated here -->
                    </div>
                </div>

                <!-- Incorrect Questions Review -->
                <div class="dashboard-section">
                    <h3>üéØ Review Mistakes</h3>
                    <div class="mistake-review">
                        <div class="mistake-stats">
                            <div class="stat-item">
                                <span class="stat-value" id="total-mistakes">0</span>
                                <div class="stat-label">Questions to Review</div>
                            </div>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-primary" onclick="startMistakeMode()" id="practice-mistakes-btn">üîÑ Practice My Mistakes</button>
                            <button class="btn btn-secondary" onclick="showMistakesList()">üìã View All Mistakes</button>
                        </div>
                    </div>
                </div>

                <!-- Achievements -->
                <div class="dashboard-section">
                    <h3>üèÜ Achievements</h3>
                    <div id="achievements-grid" class="achievements-grid">
                        <!-- Achievements will be populated here -->
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="showWelcome()">üè† Back to Menu</button>
                <button class="btn btn-secondary" onclick="exportUserData()">üì§ Export Data</button>
            </div>
        </div>

        <!-- Parent Dashboard Screen -->
        <div class="screen" id="parent-dashboard-screen">
            <h2>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parent Dashboard</h2>
            <p class="subtitle">Overview of all users' progress</p>
            
            <div id="parent-dashboard-content">
                <!-- Parent dashboard content will be populated here -->
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="showUserScreen()">üè† Back to Users</button>
                <button class="btn btn-secondary" onclick="exportAllData()">üì§ Export All Data</button>
                <button class="btn btn-secondary" onclick="showImportData()">üì• Import Data</button>
            </div>
        </div>

        <!-- Mistakes List Screen -->
        <div class="screen" id="mistakes-screen">
            <h2>üìã Your Mistakes to Review</h2>
            <div id="mistakes-list">
                <!-- Mistakes will be populated here -->
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="showDashboard()">üìä Back to Dashboard</button>
                <button class="btn btn-secondary" onclick="clearMistakes()">üóëÔ∏è Clear All Mistakes</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="screen" id="results-screen">
            <div class="celebration" id="celebration-emoji">üéâ</div>
            <h2>Session Complete!</h2>
            <div id="final-message"></div>
            
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-value" id="final-score">0/0</span>
                    <div class="stat-label">Questions Correct</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="final-percentage">0%</span>
                    <div class="stat-label">Percentage</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="final-hints">0</span>
                    <div class="stat-label">Hints Used</div>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="final-time">0:00</span>
                    <div class="stat-label">Time Taken</div>
                </div>
            </div>
            
            <div class="button-group">
                <div id="session-achievements">
                    <!-- New achievements will be shown here -->
                </div>
                <button class="btn btn-primary" onclick="startMode(currentMode)">üîÑ Try Again</button>
                <button class="btn btn-secondary" onclick="showWelcome()">üè† Change Mode</button>
                <button class="btn btn-secondary" onclick="showDashboard()">üìä View Progress</button>
                <button class="btn btn-secondary" onclick="showBestScores()">üèÜ Best Scores</button>
            </div>
        </div>

        <!-- Best Scores Screen -->
        <div class="screen" id="scores-screen">
            <h2>üèÜ Best Scores</h2>
            <div id="scores-container"></div>
            <button class="btn btn-primary" onclick="showWelcome()">üè† Back to Menu</button>
        </div>
        
        <!-- Leaderboard Screen -->
        <div class="screen" id="leaderboard-screen">
            <h2>üèÜ Leaderboard</h2>
            <div class="leaderboard-tabs">
                <button class="tab-btn active" data-tab="overall" onclick="showLeaderboardTab('overall')">üìä Overall</button>
                <button class="tab-btn" data-tab="weekly" onclick="showLeaderboardTab('weekly')">üìÖ This Week</button>
                <button class="tab-btn" data-tab="accuracy" onclick="showLeaderboardTab('accuracy')">üéØ Accuracy</button>
                <button class="tab-btn" data-tab="time" onclick="showLeaderboardTab('time')">‚è±Ô∏è Time</button>
                <button class="tab-btn" data-tab="improvement" onclick="showLeaderboardTab('improvement')">üìà Improvement</button>
                <button class="tab-btn" data-tab="streak" onclick="showLeaderboardTab('streak')">üî• Streak</button>
                <button class="tab-btn" data-tab="champions" onclick="showLeaderboardTab('champions')">üåü Champions</button>
            </div>
            
            <div id="leaderboard-content">
                <!-- Leaderboard content will be populated here -->
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="showWelcome()">üè† Back to Menu</button>
                <button class="btn btn-secondary" onclick="startMode('practice')">üéØ Practice to Climb!</button>
            </div>
        </div>
    </div>

    <!-- TESTING PANEL -->
    <div id="testing-panel" style="position: fixed; top: 50px; right: 10px; background: var(--color-surface); border: 2px solid var(--color-primary); border-radius: var(--radius-base); padding: var(--space-12); font-size: var(--font-size-sm); box-shadow: var(--shadow-lg); z-index: 999998; max-width: 250px;">
        <div style="font-weight: var(--font-weight-bold); color: var(--color-primary); margin-bottom: var(--space-8);">üß™ TESTING MODE</div>
        <button onclick="testCreateUserFlow()" style="width: 100%; margin-bottom: var(--space-4); padding: var(--space-4); background: var(--app-success); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer;">Test Create User</button>
        <button onclick="testModalVisibility()" style="width: 100%; margin-bottom: var(--space-4); padding: var(--space-4); background: var(--app-warning); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer;">Test Modal</button>
        <button onclick="hideTesting()" style="width: 100%; padding: var(--space-4); background: var(--color-error); color: white; border: none; border-radius: var(--radius-sm); cursor: pointer;">Hide Testing</button>
    </div>

    <footer style="position: fixed; bottom: 10px; right: 15px; font-size: 11px; color: rgba(255,255,255,0.7); background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 4px;">
        Version 1.5 - CRITICAL FIX: User creation now working properly
    </footer>

    <!-- DEBUG BUTTON FOR TESTING -->
    <button onclick="console.log('Button test'); alert('Button works!');" style="position: fixed; top: 10px; right: 10px; z-index: 999999; background: red; color: white; padding: 8px; border: none; border-radius: 4px;">
        Test Button
    </button>

    <script>
        // ============================================
        // INITIALIZE APP - CRITICAL USER CREATION FIX
        // ============================================
        console.log('üöÄ Maths Adventure App starting...');
        console.log('Version: 1.5 - User creation bug fix');
        
        // Game state
        let currentMode = '';
        let questionBank = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let totalQuestions = 0;
        let hintsUsed = 0;
        let startTime = null;
        let timerInterval = null;
        let timeRemaining = 0;
        let isAnswered = false;
        let currentHintShown = false;
        let sessionQuestions = []; // Track questions in current session
        let isMistakeMode = false;

        // User management
        let currentUser = null;
        let allUsers = {};
        let selectedAvatar = 'üöÄ';
        
        // Leaderboard system
        let leaderboards = {
            overall: [],
            weekly: [],
            accuracy: [],
            practiceTime: [],
            improvement: [],
            streak: [],
            categories: {
                'Word Problems': [],
                'Basic Arithmetic': [],
                'Advanced Arithmetic': [],
                'Geometry & Measurement': [],
                'Fractions & Patterns': [],
                'Logic & Reasoning': []
            }
        };
        
        // Points system constants
        const POINTS = {
            correct_answer: 10,
            correct_without_hint: 15,
            first_try_correct: 20,
            challenge_completion: 50,
            perfect_session: 25,
            daily_streak: 10,
            retry_correction: 5,
            ten_in_row: 30,
            speed_bonus: 40
        };
        
        let sessionPoints = 0;
        let sessionPointsEarned = [];
        let weeklyResetDate = getWeeklyResetDate();
        let currentLeaderboardTab = 'overall';
        let perfectStreak = 0;
        let consecutiveCorrect = 0;
        
        // Leaderboard helper functions
        function getWeeklyResetDate() {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const daysUntilMonday = dayOfWeek === 0 ? 1 : 8 - dayOfWeek; // Next Monday
            const nextMonday = new Date(now.getTime() + daysUntilMonday * 24 * 60 * 60 * 1000);
            nextMonday.setHours(0, 0, 0, 0);
            return nextMonday;
        }
        
        function checkWeeklyReset() {
            const now = new Date();
            if (now >= weeklyResetDate) {
                // Reset weekly points for all users
                Object.values(allUsers).forEach(user => {
                    user.points.lastWeek = user.points.thisWeek || 0;
                    user.points.thisWeek = 0;
                });
                weeklyResetDate = getWeeklyResetDate();
                saveUserData();
            }
        }
        
        function calculatePoints(questionDetails) {
            let points = 0;
            
            if (questionDetails.isCorrect) {
                consecutiveCorrect++;
                
                // Base points for correct answer
                points += POINTS.correct_answer;
                
                // Bonus for no hint used
                if (!questionDetails.hintUsed) {
                    points += POINTS.correct_without_hint - POINTS.correct_answer;
                }
                
                // First try correct bonus
                if (!questionDetails.hintUsed && currentQuestionIndex === 0) {
                    points += POINTS.first_try_correct - POINTS.correct_without_hint;
                }
                
                // Ten in a row bonus
                if (consecutiveCorrect >= 10 && consecutiveCorrect % 10 === 0) {
                    points += POINTS.ten_in_row;
                    showPointsEarned(POINTS.ten_in_row, '10 in a row bonus! üéØ');
                }
                
                // Track perfect streak
                perfectStreak++;
            } else {
                consecutiveCorrect = 0;
                perfectStreak = 0;
            }
            
            return points;
        }
        
        function showPointsEarned(points, message = '') {
            const pointsDiv = document.createElement('div');
            pointsDiv.className = 'points-earned';
            pointsDiv.innerHTML = `+${points} points! ‚≠ê${message ? '<br>' + message : ''}`;
            document.body.appendChild(pointsDiv);
            
            setTimeout(() => {
                if (pointsDiv.parentNode) {
                    pointsDiv.parentNode.removeChild(pointsDiv);
                }
            }, 2000);
        }
        
        function updateLeaderboards() {
            checkWeeklyReset();
            
            // Overall leaderboard
            leaderboards.overall = Object.values(allUsers)
                .filter(user => !user.hideFromLeaderboards)
                .sort((a, b) => (b.points.total || 0) - (a.points.total || 0))
                .map((user, index) => ({
                    rank: index + 1,
                    username: user.username,
                    avatar: user.avatar,
                    points: user.points.total || 0,
                    change: calculateRankChange(user, 'overall', index + 1)
                }));
            
            // Weekly leaderboard
            leaderboards.weekly = Object.values(allUsers)
                .filter(user => !user.hideFromLeaderboards)
                .sort((a, b) => (b.points.thisWeek || 0) - (a.points.thisWeek || 0))
                .map((user, index) => ({
                    rank: index + 1,
                    username: user.username,
                    avatar: user.avatar,
                    points: user.points.thisWeek || 0,
                    change: calculateRankChange(user, 'weekly', index + 1)
                }));
            
            // Accuracy leaderboard
            leaderboards.accuracy = Object.values(allUsers)
                .filter(user => !user.hideFromLeaderboards && user.totalQuestionsAttempted >= 20)
                .sort((a, b) => {
                    const aAccuracy = (a.totalCorrect / a.totalQuestionsAttempted) * 100;
                    const bAccuracy = (b.totalCorrect / b.totalQuestionsAttempted) * 100;
                    return bAccuracy - aAccuracy;
                })
                .map((user, index) => {
                    const accuracy = Math.round((user.totalCorrect / user.totalQuestionsAttempted) * 100);
                    return {
                        rank: index + 1,
                        username: user.username,
                        avatar: user.avatar,
                        points: accuracy,
                        displayValue: accuracy + '%',
                        change: calculateRankChange(user, 'accuracy', index + 1)
                    };
                });
            
            // Practice time leaderboard (this week)
            leaderboards.practiceTime = Object.values(allUsers)
                .filter(user => !user.hideFromLeaderboards)
                .sort((a, b) => getWeekTime(b) - getWeekTime(a))
                .map((user, index) => ({
                    rank: index + 1,
                    username: user.username,
                    avatar: user.avatar,
                    points: getWeekTime(user),
                    displayValue: formatTime(getWeekTime(user)),
                    change: calculateRankChange(user, 'time', index + 1)
                }));
            
            // Improvement leaderboard
            leaderboards.improvement = Object.values(allUsers)
                .filter(user => !user.hideFromLeaderboards && (user.points.lastWeek || 0) > 0)
                .sort((a, b) => {
                    const aImprovement = ((a.points.thisWeek || 0) - (a.points.lastWeek || 0)) / (a.points.lastWeek || 1) * 100;
                    const bImprovement = ((b.points.thisWeek || 0) - (b.points.lastWeek || 0)) / (b.points.lastWeek || 1) * 100;
                    return bImprovement - aImprovement;
                })
                .map((user, index) => {
                    const improvement = Math.round(((user.points.thisWeek || 0) - (user.points.lastWeek || 0)) / (user.points.lastWeek || 1) * 100);
                    return {
                        rank: index + 1,
                        username: user.username,
                        avatar: user.avatar,
                        points: improvement,
                        displayValue: (improvement > 0 ? '+' : '') + improvement + '%',
                        change: calculateRankChange(user, 'improvement', index + 1)
                    };
                });
            
            // Streak leaderboard
            leaderboards.streak = Object.values(allUsers)
                .filter(user => !user.hideFromLeaderboards)
                .sort((a, b) => calculateStreak(b) - calculateStreak(a))
                .map((user, index) => ({
                    rank: index + 1,
                    username: user.username,
                    avatar: user.avatar,
                    points: calculateStreak(user),
                    displayValue: calculateStreak(user) + ' days üî•',
                    change: calculateRankChange(user, 'streak', index + 1)
                }));
            
            // Category champions
            Object.keys(leaderboards.categories).forEach(category => {
                leaderboards.categories[category] = Object.values(allUsers)
                    .filter(user => !user.hideFromLeaderboards && user.categoryStats[category] && user.categoryStats[category].attempted > 0)
                    .sort((a, b) => {
                        const aAccuracy = (a.categoryStats[category].correct / a.categoryStats[category].attempted) * 100;
                        const bAccuracy = (b.categoryStats[category].correct / b.categoryStats[category].attempted) * 100;
                        return bAccuracy - aAccuracy;
                    })
                    .slice(0, 3)
                    .map((user, index) => {
                        const accuracy = Math.round((user.categoryStats[category].correct / user.categoryStats[category].attempted) * 100);
                        return {
                            rank: index + 1,
                            username: user.username,
                            avatar: user.avatar,
                            accuracy: accuracy,
                            attempted: user.categoryStats[category].attempted
                        };
                    });
            });
            
            // Update user ranks
            Object.values(allUsers).forEach(user => {
                user.leaderboardRanks.overall = leaderboards.overall.findIndex(entry => entry.username === user.username) + 1 || 0;
                user.leaderboardRanks.weekly = leaderboards.weekly.findIndex(entry => entry.username === user.username) + 1 || 0;
                user.leaderboardRanks.accuracy = leaderboards.accuracy.findIndex(entry => entry.username === user.username) + 1 || 0;
                user.leaderboardRanks.time = leaderboards.practiceTime.findIndex(entry => entry.username === user.username) + 1 || 0;
                user.leaderboardRanks.improvement = leaderboards.improvement.findIndex(entry => entry.username === user.username) + 1 || 0;
                user.leaderboardRanks.streak = leaderboards.streak.findIndex(entry => entry.username === user.username) + 1 || 0;
            });
        }
        
        function calculateRankChange(user, type, currentRank) {
            const previousRank = user.previousRanks[type] || 0;
            if (previousRank === 0) return 'new';
            if (currentRank < previousRank) return 'up';
            if (currentRank > previousRank) return 'down';
            return 'same';
        }
        
        function calculateStreak(user = currentUser) {
            if (!user || !user.streakDays || user.streakDays.length === 0) return 0;
            
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toDateString();
            
            let streak = 0;
            const sortedDays = user.streakDays.sort((a, b) => new Date(b) - new Date(a));
            
            // Check if user practiced today or yesterday to maintain streak
            if (sortedDays[0] === today || sortedDays[0] === yesterday) {
                let currentDate = new Date(sortedDays[0]);
                streak = 1;
                
                for (let i = 1; i < sortedDays.length; i++) {
                    const prevDate = new Date(currentDate.getTime() - 24 * 60 * 60 * 1000);
                    if (sortedDays[i] === prevDate.toDateString()) {
                        streak++;
                        currentDate = prevDate;
                    } else {
                        break;
                    }
                }
            }
            
            return streak;
        }
        
        // Parent access control
        const PARENT_PASSWORD = '260283';
        let parentFailedAttempts = 0;
        let parentLockoutTime = 0;
        let parentAccessGranted = false;
        let keyPressCount = 0;
        let keyPressTimer = null;

        // Default avatars for easy selection (16 total)
        const defaultAvatars = ['üöÄ', '‚öΩ', 'üé®', 'üåü', 'üéÆ', 'ü¶Ñ', 'üåà', 'üéØ', '‚≠ê', 'üî•', 'üí´', 'üé™', 'üé≠', 'üé¨', 'üé§', 'üèÄ'];
        
        console.log('üéÜ Loaded', defaultAvatars.length, 'default avatars');
        
        // Modal management
        let selectedAvatarInModal = 'üöÄ';
        
        // Predefined names for quick user creation
        const suggestedNames = [
            'Nacho', 'Javi', 'Gonza', 'Ignacio', 'Javier', 'Gonzalo', 'Steven', 'Harry', 'Noah', 'Aden',
            'Liam', 'Rafa', 'Sergei', 'Ayana', 'Ramon', 'I√±igo', 'Luis', 'Jaime', 'Thiago', 'Leo',
            'Felipe', 'Enrique', 'Sofia', 'Flap', 'Ethan', 'Santi', 'William', 'Kaiser', 'I√±aki',
            'Cristina', 'Loreto', 'Macarena', 'Ray', 'Nina', 'Ana', 'Maria', 'Sheina', 'Paloma',
            'Totu', 'Gaby'
        ];

        // Achievement definitions
        const achievements = {
            firstSteps: { name: 'First Steps', icon: 'üë∂', desc: 'Complete 10 questions', threshold: 10 },
            centuryClub: { name: 'Century Club', icon: 'üíØ', desc: 'Complete 100 questions', threshold: 100 },
            perfectTen: { name: 'Perfect 10', icon: 'üéØ', desc: 'Get 10 in a row correct', threshold: 10 },
            speedDemon: { name: 'Speed Demon', icon: '‚ö°', desc: 'Complete Challenge Mode under 15 minutes', threshold: 1 },
            noHints: { name: 'No Hints Master', icon: 'üß†', desc: 'Complete 20 questions without hints', threshold: 20 },
            mistakeMaster: { name: 'Mistake Master', icon: 'üîÑ', desc: 'Retry and correct 10 mistakes', threshold: 10 },
            streakMaster: { name: 'Streak Master', icon: 'üî•', desc: 'Practice for 7 days in a row', threshold: 7 },
            mathWizard: { name: 'Math Wizard', icon: 'üßô', desc: 'Achieve 90% accuracy over 50+ questions', threshold: 1 }
        };

        // Names for word problems (kept for compatibility)
        const names = suggestedNames;

        // User Data Management Functions
        function initializeUserSystem() {
            loadUserData();
            showUserScreen();
        }

        function loadUserData() {
            // In-memory storage - data persists only during session
            // Note: All data is stored in JavaScript variables and will be lost when page refreshes
            // This is due to sandboxed environment restrictions
            if (Object.keys(allUsers).length === 0) {
                // Initialize with some demo users for demonstration
                initializeDemoUsers();
            }
        }

        function saveUserData() {
            // In-memory storage - no actual persistence
            // Data is maintained in JavaScript variables during the session
            console.log('User data saved to memory (session only)');
        }
        
        function initializeDemoUsers() {
            // Create some demo users for demonstration purposes
            const demoUsers = ['Gonza', 'Nacho', 'Javi'];
            const demoAvatars = ['üöÄ', 'üåü', 'üéØ'];
            
            demoUsers.forEach((name, index) => {
                if (!allUsers[name]) {
                    const user = createUserProfile(name, demoAvatars[index]);
                    // Add some demo progress
                    user.totalQuestionsAttempted = Math.floor(Math.random() * 50) + 10;
                    user.totalCorrect = Math.floor(user.totalQuestionsAttempted * (0.7 + Math.random() * 0.25));
                    user.totalIncorrect = user.totalQuestionsAttempted - user.totalCorrect;
                    user.hintsUsed = Math.floor(Math.random() * 10);
                    
                    // Add demo points
                    user.points = {
                        total: Math.floor(Math.random() * 2000) + 500,
                        thisWeek: Math.floor(Math.random() * 500) + 100,
                        lastWeek: Math.floor(Math.random() * 400) + 50
                    };
                    
                    user.achievements = ['firstSteps'];
                    if (user.totalQuestionsAttempted >= 100) {
                        user.achievements.push('centuryClub');
                    }
                    
                    // Add some streak days
                    const today = new Date();
                    for (let i = 0; i < Math.floor(Math.random() * 5) + 1; i++) {
                        const day = new Date(today.getTime() - i * 24 * 60 * 60 * 1000);
                        user.streakDays.push(day.toDateString());
                    }
                    
                    allUsers[name] = user;
                }
            });
        }

        function createUserProfile(username, avatar) {
            const now = new Date();
            return {
                username: username,
                avatar: avatar,
                createdDate: now.toLocaleDateString(),
                lastActiveDate: now.toLocaleDateString(),
                totalQuestionsAttempted: 0,
                totalCorrect: 0,
                totalIncorrect: 0,
                hintsUsed: 0,
                totalTimeSpent: 0, // in seconds
                sessions: [],
                dailyTime: {}, // Track time per day
                weeklyTime: {}, // Track time per week
                monthlyTime: {}, // Track time per month
                incorrectQuestions: [],
                categoryStats: {
                    'Basic Arithmetic': { attempted: 0, correct: 0 },
                    'Advanced Arithmetic': { attempted: 0, correct: 0 },
                    'Word Problems': { attempted: 0, correct: 0 },
                    'Geometry & Measurement': { attempted: 0, correct: 0 },
                    'Fractions & Patterns': { attempted: 0, correct: 0 },
                    'Logic & Reasoning': { attempted: 0, correct: 0 }
                },
                achievements: [],
                streakDays: [],
                perfectStreaks: [],
                // Leaderboard data
                points: {
                    total: 0,
                    thisWeek: 0,
                    lastWeek: 0
                },
                leaderboardRanks: {
                    overall: 0,
                    weekly: 0,
                    accuracy: 0,
                    time: 0,
                    improvement: 0,
                    streak: 0
                },
                previousRanks: {},
                hideFromLeaderboards: false
            };
        }



        // Utility functions
        function getRandomName() {
            return names[Math.floor(Math.random() * names.length)];
        }

        function getRandomNames(count) {
            const shuffled = [...names].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Question Bank Generator
        function generateQuestionBank() {
            const questions = [];

            // Basic Arithmetic - 165 questions
            
            // 2-digit addition (25 questions)
            for (let i = 0; i < 25; i++) {
                const a = Math.floor(Math.random() * 90) + 10;
                const b = Math.floor(Math.random() * 90) + 10;
                const result = a + b;
                questions.push({
                    question: `${a} + ${b} = ?`,
                    answer: result,
                    hint: "Add the ones column first, then the tens column. Remember to carry if needed!",
                    explanation: `Let's add step by step:\n1. Ones: ${a % 10} + ${b % 10} = ${(a % 10) + (b % 10)}\n2. Tens: ${Math.floor(a/10)} + ${Math.floor(b/10)} = ${Math.floor(a/10) + Math.floor(b/10)}\n3. Total: ${result}`,
                    category: "Basic Arithmetic"
                });
            }

            // 2-digit subtraction (25 questions)
            for (let i = 0; i < 25; i++) {
                const a = Math.floor(Math.random() * 90) + 10;
                const b = Math.floor(Math.random() * a) + 1;
                const result = a - b;
                questions.push({
                    question: `${a} - ${b} = ?`,
                    answer: result,
                    hint: "Subtract the ones column first. You might need to borrow from the tens!",
                    explanation: `Let's subtract step by step:\n1. Ones: ${a % 10} - ${b % 10} = ${(a % 10) - (b % 10)}\n2. Tens: ${Math.floor(a/10)} - ${Math.floor(b/10)} = ${Math.floor(a/10) - Math.floor(b/10)}\n3. Total: ${result}`,
                    category: "Basic Arithmetic"
                });
            }

            // 3-digit addition (20 questions)
            for (let i = 0; i < 20; i++) {
                const a = Math.floor(Math.random() * 900) + 100;
                const b = Math.floor(Math.random() * 900) + 100;
                const result = a + b;
                questions.push({
                    question: `${a} + ${b} = ?`,
                    answer: result,
                    hint: "Add column by column: ones, tens, then hundreds. Carry when needed!",
                    explanation: `Adding column by column:\n1. Ones: ${a % 10} + ${b % 10} = ${(a % 10) + (b % 10)}\n2. Tens: ${Math.floor(a/10) % 10} + ${Math.floor(b/10) % 10} = ${(Math.floor(a/10) % 10) + (Math.floor(b/10) % 10)}\n3. Hundreds: ${Math.floor(a/100)} + ${Math.floor(b/100)} = ${Math.floor(a/100) + Math.floor(b/100)}\n4. Total: ${result}`,
                    category: "Basic Arithmetic"
                });
            }

            // 3-digit subtraction (20 questions)
            for (let i = 0; i < 20; i++) {
                const a = Math.floor(Math.random() * 900) + 100;
                const b = Math.floor(Math.random() * a) + 1;
                const result = a - b;
                questions.push({
                    question: `${a} - ${b} = ?`,
                    answer: result,
                    hint: "Subtract column by column. Remember to borrow when the top digit is smaller!",
                    explanation: `Subtracting column by column:\n1. Ones: ${a % 10} - ${b % 10} = ${(a % 10) - (b % 10)}\n2. Tens: ${Math.floor(a/10) % 10} - ${Math.floor(b/10) % 10} = ${(Math.floor(a/10) % 10) - (Math.floor(b/10) % 10)}\n3. Hundreds: ${Math.floor(a/100)} - ${Math.floor(b/100)} = ${Math.floor(a/100) - Math.floor(b/100)}\n4. Total: ${result}`,
                    category: "Basic Arithmetic"
                });
            }

            // Multiplication tables 2-12 (30 questions)
            const tables = [2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
            for (let i = 0; i < 30; i++) {
                const table = tables[Math.floor(Math.random() * tables.length)];
                const multiplier = Math.floor(Math.random() * 12) + 1;
                const result = table * multiplier;
                questions.push({
                    question: `${table} √ó ${multiplier} = ?`,
                    answer: result,
                    hint: `Think about the ${table} times table. You can count in ${table}s: ${table}, ${table * 2}, ${table * 3}...`,
                    explanation: `${table} √ó ${multiplier} means ${table} groups of ${multiplier} (or ${multiplier} groups of ${table}).\nCounting: ` + Array.from({length: multiplier}, (_, i) => table * (i + 1)).join(' + ') + ` = ${result}`,
                    category: "Basic Arithmetic"
                });
            }

            // Division facts (25 questions)
            for (let i = 0; i < 25; i++) {
                const divisor = Math.floor(Math.random() * 11) + 2;
                const quotient = Math.floor(Math.random() * 12) + 1;
                const dividend = divisor * quotient;
                questions.push({
                    question: `${dividend} √∑ ${divisor} = ?`,
                    answer: quotient,
                    hint: `Think: what number times ${divisor} equals ${dividend}?`,
                    explanation: `${dividend} √∑ ${divisor} = ${quotient} because ${divisor} √ó ${quotient} = ${dividend}\nWe can check: ${divisor} √ó ${quotient} = ${dividend} ‚úì`,
                    category: "Basic Arithmetic"
                });
            }

            // Mixed operations (20 questions)
            const operations = [
                () => {
                    const a = Math.floor(Math.random() * 10) + 2;
                    const b = Math.floor(Math.random() * 10) + 2;
                    const c = Math.floor(Math.random() * 20) + 5;
                    const result = a * b + c;
                    return {
                        question: `${a} √ó ${b} + ${c} = ?`,
                        answer: result,
                        hint: "Remember order of operations: multiply first, then add!",
                        explanation: `Order of operations (BODMAS/PEMDAS):\n1. First multiply: ${a} √ó ${b} = ${a * b}\n2. Then add: ${a * b} + ${c} = ${result}`
                    };
                },
                () => {
                    const a = Math.floor(Math.random() * 50) + 50;
                    const b = Math.floor(Math.random() * 10) + 2;
                    const c = Math.floor(Math.random() * 10) + 2;
                    const result = a - b * c;
                    return {
                        question: `${a} - ${b} √ó ${c} = ?`,
                        answer: result,
                        hint: "Multiply first, then subtract!",
                        explanation: `Order of operations:\n1. First multiply: ${b} √ó ${c} = ${b * c}\n2. Then subtract: ${a} - ${b * c} = ${result}`
                    };
                }
            ];
            
            for (let i = 0; i < 20; i++) {
                const op = operations[Math.floor(Math.random() * operations.length)]();
                questions.push({
                    ...op,
                    category: "Basic Arithmetic"
                });
            }

            // Advanced Arithmetic - 70 questions
            
            // 4-digit addition (15 questions)
            for (let i = 0; i < 15; i++) {
                const a = Math.floor(Math.random() * 9000) + 1000;
                const b = Math.floor(Math.random() * 9000) + 1000;
                const result = a + b;
                questions.push({
                    question: `${a.toLocaleString()} + ${b.toLocaleString()} = ?`,
                    answer: result,
                    hint: "Add each column carefully from right to left. Don't forget to carry!",
                    explanation: `Adding ${a.toLocaleString()} + ${b.toLocaleString()}:\nWorking column by column from right to left:\nAnswer: ${result.toLocaleString()}`,
                    category: "Advanced Arithmetic"
                });
            }

            // 4-digit subtraction (15 questions)
            for (let i = 0; i < 15; i++) {
                const a = Math.floor(Math.random() * 9000) + 1000;
                const b = Math.floor(Math.random() * a) + 1;
                const result = a - b;
                questions.push({
                    question: `${a.toLocaleString()} - ${b.toLocaleString()} = ?`,
                    answer: result,
                    hint: "Subtract each column from right to left. Borrow when needed!",
                    explanation: `Subtracting ${a.toLocaleString()} - ${b.toLocaleString()}:\nWorking column by column from right to left:\nAnswer: ${result.toLocaleString()}`,
                    category: "Advanced Arithmetic"
                });
            }

            // 3-digit √ó 1-digit multiplication (15 questions)
            for (let i = 0; i < 15; i++) {
                const a = Math.floor(Math.random() * 900) + 100;
                const b = Math.floor(Math.random() * 9) + 2;
                const result = a * b;
                questions.push({
                    question: `${a} √ó ${b} = ?`,
                    answer: result,
                    hint: "Multiply each digit by ${b}, starting from the right. Remember to carry!",
                    explanation: `${a} √ó ${b}:\nMultiply each digit:\n${a % 10} √ó ${b} = ${(a % 10) * b}\n${Math.floor(a/10) % 10} √ó ${b} = ${(Math.floor(a/10) % 10) * b}\n${Math.floor(a/100)} √ó ${b} = ${Math.floor(a/100) * b}\nAnswer: ${result}`,
                    category: "Advanced Arithmetic"
                });
            }

            // Division with remainders (15 questions)
            for (let i = 0; i < 15; i++) {
                const divisor = Math.floor(Math.random() * 8) + 3;
                const quotient = Math.floor(Math.random() * 20) + 5;
                const remainder = Math.floor(Math.random() * (divisor - 1)) + 1;
                const dividend = divisor * quotient + remainder;
                questions.push({
                    question: `${dividend} √∑ ${divisor} = ? remainder ?`,
                    answer: `${quotient} remainder ${remainder}`,
                    acceptableAnswers: [`${quotient} remainder ${remainder}`, `${quotient} r ${remainder}`, `${quotient} R ${remainder}`, `${quotient}r${remainder}`, `${quotient}R${remainder}`],
                    hint: "Find how many times ${divisor} goes into ${dividend}, then find what's left over!",
                    explanation: `${dividend} √∑ ${divisor}:\n${divisor} √ó ${quotient} = ${divisor * quotient}\n${dividend} - ${divisor * quotient} = ${remainder}\nSo ${dividend} √∑ ${divisor} = ${quotient} remainder ${remainder}`,
                    category: "Advanced Arithmetic"
                });
            }

            // Mental strategies (10 questions)
            const mentalStrategies = [
                () => {
                    const base = Math.floor(Math.random() * 9) * 100 + 99; // 199, 299, etc.
                    const add = Math.floor(Math.random() * 50) + 10;
                    const result = base + add;
                    return {
                        question: `${base} + ${add} = ?`,
                        answer: result,
                        hint: "Try adding 1 first to make a round hundred, then adjust!",
                        explanation: `${base} + ${add}:\n${base} is 1 less than ${base + 1}\nSo: ${base + 1} + ${add} - 1 = ${base + 1 + add} - 1 = ${result}`
                    };
                },
                () => {
                    const from = 1000;
                    const subtract = Math.floor(Math.random() * 400) + 100;
                    const result = from - subtract;
                    return {
                        question: `${from} - ${subtract} = ?`,
                        answer: result,
                        hint: "Count up from ${subtract} to 1000!",
                        explanation: `1000 - ${subtract}:\nThink: ${subtract} + ? = 1000\nAnswer: ${result}`
                    };
                }
            ];

            for (let i = 0; i < 10; i++) {
                const strategy = mentalStrategies[Math.floor(Math.random() * mentalStrategies.length)]();
                questions.push({
                    ...strategy,
                    category: "Advanced Arithmetic"
                });
            }

            // Word Problems - 200 questions
            
            // Basic word problems (40 questions)
            for (let i = 0; i < 40; i++) {
                const basicTypes = [
                    () => {
                        const name = getRandomName();
                        const initial = Math.floor(Math.random() * 30) + 10;
                        const gained = Math.floor(Math.random() * 20) + 5;
                        const items = ['apples', 'stickers', 'marbles', 'books', 'toys'][Math.floor(Math.random() * 5)];
                        return {
                            question: `${name} has ${initial} ${items}. Then ${name} gets ${gained} more ${items}. How many ${items} does ${name} have now?`,
                            answer: initial + gained,
                            hint: "Add the ${items} ${name} started with to the new ones!",
                            explanation: `${name} started with ${initial} ${items}\nThen got ${gained} more\nTotal: ${initial} + ${gained} = ${initial + gained} ${items}`
                        };
                    },
                    () => {
                        const name = getRandomName();
                        const initial = Math.floor(Math.random() * 50) + 20;
                        const lost = Math.floor(Math.random() * 15) + 5;
                        const items = ['pencils', 'cards', 'coins', 'shells', 'stones'][Math.floor(Math.random() * 5)];
                        return {
                            question: `${name} had ${initial} ${items}. ${name} lost ${lost} ${items}. How many ${items} does ${name} have left?`,
                            answer: initial - lost,
                            hint: "Subtract the lost ${items} from what ${name} started with!",
                            explanation: `${name} started with ${initial} ${items}\nLost ${lost} ${items}\nLeft with: ${initial} - ${lost} = ${initial - lost} ${items}`
                        };
                    },
                    () => {
                        const name1 = getRandomName();
                        const name2 = getRandomName();
                        const amount1 = Math.floor(Math.random() * 25) + 10;
                        const amount2 = Math.floor(Math.random() * 25) + 10;
                        const items = ['stickers', 'stamps', 'buttons', 'beads', 'gems'][Math.floor(Math.random() * 5)];
                        return {
                            question: `${name1} has ${amount1} ${items} and ${name2} has ${amount2} ${items}. How many ${items} do they have altogether?`,
                            answer: amount1 + amount2,
                            hint: "Add both amounts together!",
                            explanation: `${name1} has ${amount1} ${items}\n${name2} has ${amount2} ${items}\nTogether: ${amount1} + ${amount2} = ${amount1 + amount2} ${items}`
                        };
                    }
                ];
                
                const problem = basicTypes[Math.floor(Math.random() * basicTypes.length)]();
                questions.push({
                    ...problem,
                    category: "Word Problems"
                });
            }
            
            // Multi-step word problems (40 questions)
            for (let i = 0; i < 40; i++) {
                const multiStepTypes = [
                    () => {
                        const name = getRandomName();
                        const name2 = getRandomName();
                        const name3 = getRandomName();
                        const initial = Math.floor(Math.random() * 30) + 15;
                        const given = Math.floor(Math.random() * 10) + 5;
                        const received = Math.floor(Math.random() * 15) + 8;
                        const items = ['cards', 'stickers', 'marbles', 'coins'][Math.floor(Math.random() * 4)];
                        return {
                            question: `${name} has ${initial} ${items}. ${name} gives ${given} ${items} to ${name2}. Then ${name3} gives ${name} ${received} ${items}. How many ${items} does ${name} have now?`,
                            answer: initial - given + received,
                            hint: "Start with ${initial}, subtract ${given}, then add ${received}!",
                            explanation: `Step 1: ${name} starts with ${initial} ${items}\nStep 2: Gives away ${given}: ${initial} - ${given} = ${initial - given}\nStep 3: Receives ${received}: ${initial - given} + ${received} = ${initial - given + received}\nFinal answer: ${initial - given + received} ${items}`
                        };
                    },
                    () => {
                        const name = getRandomName();
                        const boxes = Math.floor(Math.random() * 8) + 3;
                        const perBox = Math.floor(Math.random() * 12) + 5;
                        const extra = Math.floor(Math.random() * 20) + 10;
                        const items = ['chocolates', 'cookies', 'candies', 'sweets'][Math.floor(Math.random() * 4)];
                        return {
                            question: `${name} has ${boxes} boxes with ${perBox} ${items} in each box. ${name} also has ${extra} loose ${items}. How many ${items} does ${name} have in total?`,
                            answer: boxes * perBox + extra,
                            hint: "First multiply boxes by ${items} per box, then add the extra!",
                            explanation: `Step 1: ${items} in boxes: ${boxes} √ó ${perBox} = ${boxes * perBox}\nStep 2: Add loose ${items}: ${boxes * perBox} + ${extra} = ${boxes * perBox + extra}\nTotal: ${boxes * perBox + extra} ${items}`
                        };
                    }
                ];
                
                const problem = multiStepTypes[Math.floor(Math.random() * multiStepTypes.length)]();
                questions.push({
                    ...problem,
                    category: "Word Problems"
                });
            }
            
            // Time problems (20 questions)
            for (let i = 0; i < 20; i++) {
                const timeTypes = [
                    () => {
                        const name = getRandomName();
                        const startHour = Math.floor(Math.random() * 6) + 2;
                        const startMin = Math.floor(Math.random() * 12) * 5; // 5-minute intervals
                        const durationMin = (Math.floor(Math.random() * 12) + 4) * 5; // 20-80 minutes in 5-min steps
                        const endTotalMin = startHour * 60 + startMin + durationMin;
                        const endHour = Math.floor(endTotalMin / 60);
                        const endMin = endTotalMin % 60;
                        
                        const formatTime = (h, m) => `${h}:${m.toString().padStart(2, '0')}`;
                        
                        return {
                            question: `${name} starts homework at ${formatTime(startHour, startMin)} and finishes at ${formatTime(endHour, endMin)}. How long did it take in minutes?`,
                            answer: durationMin,
                            acceptableAnswers: [`${durationMin}`, `${durationMin} minutes`, `${durationMin} mins`],
                            hint: "Count the minutes from start time to finish time!",
                            explanation: `From ${formatTime(startHour, startMin)} to ${formatTime(endHour, endMin)}\nTime taken = ${durationMin} minutes`
                        };
                    },
                    () => {
                        const name = getRandomName();
                        const activity = ['bike', 'scooter', 'skateboard', 'rollerskates'][Math.floor(Math.random() * 4)];
                        const firstHour = Math.floor(Math.random() * 10) + 15;
                        const additionalCost = Math.floor(Math.random() * 5) + 3;
                        const startTime = '11:45am';
                        const endTime = '2:15pm';
                        const totalHours = 2.5;
                        const additionalHours = 1.5;
                        const totalCost = firstHour + (additionalHours * 2 * additionalCost); // 3 additional 30-min periods
                        
                        return {
                            question: `${name} hires a ${activity}. First hour: ¬£${firstHour}, every additional 30 minutes: ¬£${additionalCost}. ${name} hires from ${startTime} to ${endTime}. How much does it cost?`,
                            answer: roundMoney(totalCost),
                            acceptableAnswers: [`¬£${totalCost}`, `${totalCost}`, `${totalCost.toFixed(2)}`],
                            hint: "Calculate: first hour + (number of 30-minute periods √ó cost per 30 minutes)!",
                            explanation: `From ${startTime} to ${endTime} = 2.5 hours\nFirst hour: ¬£${firstHour}\nRemaining 1.5 hours = 3 periods of 30 minutes\nAdditional cost: 3 √ó ¬£${additionalCost} = ¬£${additionalCost * 3}\nTotal: ¬£${firstHour} + ¬£${additionalCost * 3} = ¬£${totalCost}`
                        };
                    }
                ];
                
                const problem = timeTypes[Math.floor(Math.random() * timeTypes.length)]();
                questions.push({
                    ...problem,
                    category: "Word Problems"
                });
            }
            
            // Add the specific example from the bug report
            questions.push({
                question: "Rafa buys something for ¬£1.31 and pays with ¬£1.50. How much change does Rafa get?",
                answer: roundMoney(1.50 - 1.31),
                acceptableAnswers: ["0.19", "¬£0.19", "19", "19p"],
                hint: "Subtract the price from the amount paid!",
                explanation: "Change = Amount paid - Price\nChange = ¬£1.50 - ¬£1.31 = ¬£0.19 (or 19p)",
                category: "Word Problems"
            });
            
            // Money problems (24 more questions to total 25)
            for (let i = 0; i < 24; i++) {
                const problemTypes = [
                    () => {
                        const name1 = getRandomName();
                        const name2 = getRandomName();
                        const amount1 = roundMoney((Math.floor(Math.random() * 500) + 100) / 100);
                        const amount2 = roundMoney((Math.floor(Math.random() * 500) + 100) / 100);
                        const total = roundMoney(amount1 + amount2);
                        return {
                            question: `${name1} has ¬£${amount1.toFixed(2)}. ${name2} has ¬£${amount2.toFixed(2)}. How much do they have together?`,
                            answer: total,
                            acceptableAnswers: [`¬£${total.toFixed(2)}`, `${total.toFixed(2)}`, `${total}`, `${Math.round(total * 100)}p`],
                            hint: "Add both amounts together!",
                            explanation: `${name1} has ¬£${amount1.toFixed(2)} and ${name2} has ¬£${amount2.toFixed(2)}\nTogether: ¬£${amount1.toFixed(2)} + ¬£${amount2.toFixed(2)} = ¬£${total.toFixed(2)}`
                        };
                    },
                    () => {
                        const name = getRandomName();
                        const price = roundMoney((Math.floor(Math.random() * 300) + 50) / 100);
                        const paid = roundMoney(Math.ceil(price * 2) / 2); // Round up to nearest 50p
                        const change = roundMoney(paid - price);
                        return {
                            question: `${name} buys something for ¬£${price.toFixed(2)} and pays with ¬£${paid.toFixed(2)}. How much change does ${name} get?`,
                            answer: change,
                            acceptableAnswers: [`¬£${change.toFixed(2)}`, `${change.toFixed(2)}`, `${change}`, `${Math.round(change * 100)}`, `${Math.round(change * 100)}p`],
                            hint: "Subtract the price from the amount paid!",
                            explanation: `Change = Amount paid - Price\nChange = ¬£${paid.toFixed(2)} - ¬£${price.toFixed(2)} = ¬£${change.toFixed(2)}`
                        };
                    }
                ];
                
                const problem = problemTypes[Math.floor(Math.random() * problemTypes.length)]();
                questions.push({
                    ...problem,
                    category: "Word Problems"
                });
            }

            // Time problems (15 questions)
            for (let i = 0; i < 15; i++) {
                const timeProblems = [
                    () => {
                        const name = getRandomName();
                        const startHour = Math.floor(Math.random() * 6) + 2;
                        const startMin = Math.floor(Math.random() * 60);
                        const durationMin = Math.floor(Math.random() * 120) + 30;
                        const startTime = `${startHour}:${startMin.toString().padStart(2, '0')}`;
                        const endHour = Math.floor((startHour * 60 + startMin + durationMin) / 60);
                        const endMin = (startMin + durationMin) % 60;
                        const endTime = `${endHour}:${endMin.toString().padStart(2, '0')}`;
                        
                        return {
                            question: `${name} starts homework at ${startTime} and finishes at ${endTime}. How long did it take in minutes?`,
                            answer: durationMin,
                            acceptableAnswers: [`${durationMin}`, `${durationMin} minutes`, `${durationMin} mins`, `${durationMin}mins`],
                            hint: "Count the minutes from start time to end time!",
                            explanation: `From ${startTime} to ${endTime}:\nTotal time = ${durationMin} minutes`
                        };
                    }
                ];
                
                const problem = timeProblems[0]();
                questions.push({
                    ...problem,
                    category: "Word Problems"
                });
            }

            // Age problems (10 questions)
            for (let i = 0; i < 10; i++) {
                const name1 = getRandomName();
                const name2 = getRandomName();
                const age1 = Math.floor(Math.random() * 8) + 6;
                const ageDiff = Math.floor(Math.random() * 5) + 2;
                questions.push({
                    question: `${name1} is ${age1} years old. ${name2} is ${ageDiff} years older than ${name1}. How old is ${name2}?`,
                    answer: age1 + ageDiff,
                    acceptableAnswers: [`${age1 + ageDiff}`, `${age1 + ageDiff} years old`, `${age1 + ageDiff} years`],
                    hint: "Add the age difference to ${name1}'s age!",
                    explanation: `${name1} is ${age1} years old\n${name2} is ${ageDiff} years older\n${name2}'s age = ${age1} + ${ageDiff} = ${age1 + ageDiff} years old`,
                    category: "Word Problems"
                });
            }

            // Collection problems (20 questions)
            for (let i = 0; i < 20; i++) {
                const collectionTypes = [
                    () => {
                        const name1 = getRandomName();
                        const name2 = getRandomName();
                        const amount1 = Math.floor(Math.random() * 30) + 10;
                        const multiplier = Math.floor(Math.random() * 4) + 2;
                        const items = ['stickers', 'marbles', 'cards', 'stamps', 'coins'][Math.floor(Math.random() * 5)];
                        return {
                            question: `${name1} has ${amount1} ${items}. ${name2} has ${multiplier} times as many. How many ${items} does ${name2} have?`,
                            answer: amount1 * multiplier,
                            hint: "Multiply ${name1}'s amount by ${multiplier}!",
                            explanation: `${name1} has ${amount1} ${items}\n${name2} has ${multiplier} times as many\n${name2}'s amount = ${amount1} √ó ${multiplier} = ${amount1 * multiplier} ${items}`
                        };
                    }
                ];
                
                const problem = collectionTypes[0]();
                questions.push({
                    ...problem,
                    category: "Word Problems"
                });
            }

            // Logic puzzles with names (20 questions)
            for (let i = 0; i < 20; i++) {
                const logicTypes = [
                    () => {
                        const name1 = getRandomName();
                        const name2 = getRandomName();
                        const name3 = getRandomName();
                        const age1 = Math.floor(Math.random() * 5) + 7; // 7-11
                        const ageDiff = Math.floor(Math.random() * 3) + 2; // 2-4 years
                        const age2 = age1 + ageDiff;
                        const age3 = age2 * 2;
                        return {
                            question: `${name1} is ${age1} years old. ${name2} is ${ageDiff} years older than ${name1}. ${name3} is twice as old as ${name2}. How old is ${name3}?`,
                            answer: age3,
                            acceptableAnswers: [`${age3}`, `${age3} years old`, `${age3} years`],
                            hint: "First find ${name2}'s age, then double it for ${name3}!",
                            explanation: `Step 1: ${name2}'s age = ${age1} + ${ageDiff} = ${age2} years\nStep 2: ${name3}'s age = ${age2} √ó 2 = ${age3} years`
                        };
                    },
                    () => {
                        const name1 = getRandomName();
                        const name2 = getRandomName();
                        const name3 = getRandomName();
                        const amount1 = Math.floor(Math.random() * 15) + 10;
                        const multiplier = Math.floor(Math.random() * 3) + 3; // 3-5 times
                        const subtraction = Math.floor(Math.random() * 8) + 5;
                        const amount2 = amount1 * multiplier;
                        const amount3 = amount2 - subtraction;
                        const items = ['stickers', 'cards', 'marbles', 'coins'][Math.floor(Math.random() * 4)];
                        return {
                            question: `${name1} has ${amount1} ${items}. ${name2} has ${multiplier} times as many as ${name1}. ${name3} has ${subtraction} fewer than ${name2}. How many ${items} does ${name3} have?`,
                            answer: amount3,
                            hint: "First find how many ${name2} has, then subtract ${subtraction} for ${name3}!",
                            explanation: `Step 1: ${name2} has ${amount1} √ó ${multiplier} = ${amount2} ${items}\nStep 2: ${name3} has ${amount2} - ${subtraction} = ${amount3} ${items}`
                        };
                    }
                ];
                
                const problem = logicTypes[Math.floor(Math.random() * logicTypes.length)]();
                questions.push({
                    ...problem,
                    category: "Word Problems"
                });
            }
            
            // Patterns and sequences (15 questions)
            for (let i = 0; i < 15; i++) {
                const patternTypes = [
                    () => {
                        const start = 2;
                        const sequence = [2, 6, 12, 20, 30];
                        const next = 42; // +4, +6, +8, +10, +12
                        return {
                            question: "What number comes next in this pattern? 2, 6, 12, 20, 30, ?",
                            answer: next,
                            hint: "Look at the differences between consecutive numbers: +4, +6, +8, +10, ...",
                            explanation: "The pattern is adding increasing even numbers:\n2 + 4 = 6\n6 + 6 = 12\n12 + 8 = 20\n20 + 10 = 30\n30 + 12 = 42"
                        };
                    },
                    () => {
                        return {
                            question: "Complete the pattern: 3, 9, 27, 81, ?",
                            answer: 243,
                            hint: "Each number is multiplied by 3 to get the next!",
                            explanation: "Each number is multiplied by 3:\n3 √ó 3 = 9\n9 √ó 3 = 27\n27 √ó 3 = 81\n81 √ó 3 = 243"
                        };
                    },
                    () => {
                        return {
                            question: "What number comes next: 121323, 132434, 143545, ?",
                            answer: 154656,
                            hint: "Look at what's being added: 11111 each time!",
                            explanation: "Each number increases by 11111:\n121323 + 11111 = 132434\n132434 + 11111 = 143545\n143545 + 11111 = 154656"
                        };
                    }
                ];
                
                const problem = patternTypes[Math.floor(Math.random() * patternTypes.length)]();
                questions.push({
                    ...problem,
                    category: "Word Problems"
                });
            }
            
            // Geometry word problems (15 questions)
            for (let i = 0; i < 15; i++) {
                const geometryTypes = [
                    () => {
                        const increase = Math.floor(Math.random() * 3) + 3; // 3-5 cm
                        const newPerimeter = Math.floor(Math.random() * 10) + 20; // 20-29 cm
                        const newWidth = (newPerimeter / 2) - 8; // Assuming original length was 8
                        const originalWidth = newWidth - increase;
                        const originalPerimeter = 2 * (8 + originalWidth);
                        return {
                            question: `If you increase the width of a rectangle by ${increase} cm, you get a rectangle with a perimeter of ${newPerimeter} cm. The length stays 8 cm. What was the original perimeter?`,
                            answer: Math.round(originalPerimeter),
                            acceptableAnswers: [`${Math.round(originalPerimeter)}`, `${Math.round(originalPerimeter)} cm`],
                            hint: "Work backwards: find the new width, then subtract ${increase} cm to get the original width!",
                            explanation: `New perimeter = 2 √ó (length + new width)\n${newPerimeter} = 2 √ó (8 + new width)\nNew width = ${newWidth} cm\nOriginal width = ${newWidth} - ${increase} = ${originalWidth} cm\nOriginal perimeter = 2 √ó (8 + ${originalWidth}) = ${Math.round(originalPerimeter)} cm`
                        };
                    },
                    () => {
                        const side = Math.floor(Math.random() * 6) + 6; // 6-11 cm
                        const rectLength = side + Math.floor(Math.random() * 4) + 2; // 2-5 cm longer
                        const rectWidth = (side * 4 / 2) - rectLength; // Same perimeter
                        return {
                            question: `A square and rectangle have the same perimeter. The square has sides of ${side} cm. The rectangle is ${rectLength} cm long. What is the rectangle's width?`,
                            answer: Math.round(rectWidth),
                            acceptableAnswers: [`${Math.round(rectWidth)}`, `${Math.round(rectWidth)} cm`],
                            hint: "Find the square's perimeter first, then use it to find the rectangle's width!",
                            explanation: `Square perimeter = 4 √ó ${side} = ${side * 4} cm\nRectangle perimeter = 2 √ó (length + width)\n${side * 4} = 2 √ó (${rectLength} + width)\nWidth = ${Math.round(rectWidth)} cm`
                        };
                    }
                ];
                
                const problem = geometryTypes[Math.floor(Math.random() * geometryTypes.length)]();
                questions.push({
                    ...problem,
                    category: "Word Problems"
                });
            }
            
            // Algebraic thinking (10 questions)
            for (let i = 0; i < 10; i++) {
                const algebraicTypes = [
                    () => {
                        return {
                            question: "Work out the value of ‚óá √ó ‚óè. Given: ‚óá + ‚óá = 16, ‚óè + ‚óè + ‚óè = 15",
                            answer: 40,
                            hint: "First find ‚óá by dividing 16 by 2, then find ‚óè by dividing 15 by 3!",
                            explanation: "‚óá + ‚óá = 16, so ‚óá = 16 √∑ 2 = 8\n‚óè + ‚óè + ‚óè = 15, so ‚óè = 15 √∑ 3 = 5\n‚óá √ó ‚óè = 8 √ó 5 = 40"
                        };
                    },
                    () => {
                        const name = getRandomName();
                        const result = [16, 20, 24, 28, 32, 36][Math.floor(Math.random() * 6)];
                        const answer = result / 4;
                        return {
                            question: `${name} thinks of a number. When multiplied by 4, it equals ${result}. What is the number?`,
                            answer: answer,
                            hint: "What number times 4 equals ${result}? Try dividing!",
                            explanation: `Let the number be x\nx √ó 4 = ${result}\nx = ${result} √∑ 4 = ${answer}`
                        };
                    }
                ];
                
                const problem = algebraicTypes[Math.floor(Math.random() * algebraicTypes.length)]();
                questions.push({
                    ...problem,
                    category: "Word Problems"
                });
            }
            
            // Number theory (10 questions)
            for (let i = 0; i < 10; i++) {
                const numberTheoryTypes = [
                    () => {
                        return {
                            question: "The digit-sum of a number is the sum of that number's digits. For example, the digit-sum of 45 is 4 + 5 = 9. How many odd two-digit numbers have an odd digit-sum?",
                            answer: 25,
                            hint: "Think systematically: for a two-digit number to have an odd digit-sum, one digit must be odd and one even!",
                            explanation: "For an odd digit-sum, we need one odd digit and one even digit.\nOdd digits: 1, 3, 5, 7, 9 (5 options)\nEven digits: 0, 2, 4, 6, 8 (5 options)\nTwo-digit combinations: 5 √ó 5 = 25 numbers"
                        };
                    },
                    () => {
                        const name1 = getRandomName();
                        const name2 = getRandomName();
                        const largest = 9876;
                        const smallest = 1023;
                        const difference = largest - smallest;
                        return {
                            question: `${name1} and ${name2} each think of a four-digit number. ${name1} thinks of the largest four-digit number with no repeating digits. ${name2} thinks of the smallest four-digit number with no repeating digits. What is the difference?`,
                            answer: difference,
                            hint: "Largest with no repeating digits: 9876. Smallest with no repeating digits: 1023!",
                            explanation: `Largest four-digit number with no repeating digits: 9876\nSmallest four-digit number with no repeating digits: 1023\nDifference: 9876 - 1023 = ${difference}`
                        };
                    }
                ];
                
                const problem = numberTheoryTypes[Math.floor(Math.random() * numberTheoryTypes.length)]();
                questions.push({
                    ...problem,
                    category: "Word Problems"
                });
            }
            
            // Mixed challenging problems (5 questions)
            for (let i = 0; i < 5; i++) {
                const challengingTypes = [
                    () => {
                        const name = getRandomName();
                        const pizzas = Math.floor(Math.random() * 3) + 2; // 2-4 pizzas
                        const slicesPerPizza = 8;
                        const people = Math.floor(Math.random() * 4) + 4; // 4-7 people
                        const totalSlices = pizzas * slicesPerPizza;
                        const slicesPerPerson = Math.floor(totalSlices / people);
                        const leftover = totalSlices % people;
                        return {
                            question: `${name} orders ${pizzas} pizzas for a party. Each pizza has ${slicesPerPizza} slices. If ${people} people share equally, how many slices does each person get and how many are left over?`,
                            answer: `${slicesPerPerson} each, ${leftover} left over`,
                            acceptableAnswers: [`${slicesPerPerson} each, ${leftover} left over`, `${slicesPerPerson} remainder ${leftover}`, `${slicesPerPerson} each with ${leftover} left`],
                            hint: "Find total slices, then divide by number of people!",
                            explanation: `Total slices: ${pizzas} √ó ${slicesPerPizza} = ${totalSlices}\nSlices per person: ${totalSlices} √∑ ${people} = ${slicesPerPerson} remainder ${leftover}\nAnswer: ${slicesPerPerson} each, ${leftover} left over`
                        };
                    }
                ];
                
                const problem = challengingTypes[0]();
                questions.push({
                    ...problem,
                    category: "Word Problems"
                });
            }

            // Geometry & Measurement - 43 questions
            
            // Area/Perimeter (15 questions)
            for (let i = 0; i < 15; i++) {
                const geometryProblems = [
                    () => {
                        const length = Math.floor(Math.random() * 10) + 3;
                        const width = Math.floor(Math.random() * 8) + 2;
                        const area = length * width;
                        return {
                            question: `A rectangle is ${length} cm long and ${width} cm wide. What is its area?`,
                            answer: area,
                            acceptableAnswers: [`${area}`, `${area} cm¬≤`, `${area} square cm`, `${area} sq cm`],
                            hint: "Area of rectangle = length √ó width",
                            explanation: `Area = length √ó width\nArea = ${length} √ó ${width} = ${area} cm¬≤`
                        };
                    },
                    () => {
                        const length = Math.floor(Math.random() * 10) + 3;
                        const width = Math.floor(Math.random() * 8) + 2;
                        const perimeter = 2 * (length + width);
                        return {
                            question: `A rectangle is ${length} cm long and ${width} cm wide. What is its perimeter?`,
                            answer: perimeter,
                            acceptableAnswers: [`${perimeter}`, `${perimeter} cm`],
                            hint: "Perimeter = 2 √ó (length + width)",
                            explanation: `Perimeter = 2 √ó (length + width)\nPerimeter = 2 √ó (${length} + ${width}) = 2 √ó ${length + width} = ${perimeter} cm`
                        };
                    }
                ];
                
                const problem = geometryProblems[Math.floor(Math.random() * geometryProblems.length)]();
                questions.push({
                    ...problem,
                    category: "Geometry & Measurement"
                });
            }

            // Shape properties (10 questions)
            const shapeQuestions = [
                {question: "How many sides does a triangle have?", answer: 3, hint: "Count the sides of a triangle!", explanation: "A triangle has 3 sides by definition."},
                {question: "How many sides does a rectangle have?", answer: 4, hint: "Count the sides of a rectangle!", explanation: "A rectangle has 4 sides."},
                {question: "How many sides does a pentagon have?", answer: 5, hint: "The prefix 'penta' means five!", explanation: "A pentagon has 5 sides. 'Penta' means five."},
                {question: "How many sides does a hexagon have?", answer: 6, hint: "The prefix 'hexa' means six!", explanation: "A hexagon has 6 sides. 'Hexa' means six."},
                {question: "How many sides does an octagon have?", answer: 8, hint: "Think of an octopus - it has 8 arms!", explanation: "An octagon has 8 sides. Like an octopus with 8 arms!"},
                {question: "How many corners does a square have?", answer: 4, hint: "Count the corners where the sides meet!", explanation: "A square has 4 corners (vertices) where the sides meet."},
                {question: "How many lines of symmetry does a square have?", answer: 4, hint: "Think about folding a square in half different ways!", explanation: "A square has 4 lines of symmetry: 2 diagonal lines and 2 lines through the middle."},
                {question: "What shape has no corners?", answer: "circle", acceptableAnswers: ["circle", "a circle"], hint: "Think of a shape that is completely round!", explanation: "A circle has no corners because it is perfectly round."},
                {question: "How many sides does a square have?", answer: 4, hint: "All sides of a square are equal!", explanation: "A square has 4 equal sides."},
                {question: "How many right angles does a rectangle have?", answer: 4, hint: "Right angles are 90 degrees - like the corner of a book!", explanation: "A rectangle has 4 right angles (90¬∞ each)."}
            ];
            
            for (let i = 0; i < 10; i++) {
                const shape = shapeQuestions[i];
                questions.push({
                    ...shape,
                    category: "Geometry & Measurement"
                });
            }

            // Conversions (10 questions)
            for (let i = 0; i < 10; i++) {
                const conversionProblems = [
                    () => {
                        const meters = Math.floor(Math.random() * 5) + 1;
                        const centimeters = meters * 100;
                        return {
                            question: `How many centimeters are in ${meters} meter${meters > 1 ? 's' : ''}?`,
                            answer: centimeters,
                            acceptableAnswers: [`${centimeters}`, `${centimeters} cm`, `${centimeters} centimeters`],
                            hint: "There are 100 centimeters in 1 meter!",
                            explanation: `1 meter = 100 centimeters\n${meters} meter${meters > 1 ? 's' : ''} = ${meters} √ó 100 = ${centimeters} centimeters`
                        };
                    },
                    () => {
                        const kg = Math.floor(Math.random() * 8) + 1;
                        const grams = kg * 1000;
                        return {
                            question: `How many grams are in ${kg} kilogram${kg > 1 ? 's' : ''}?`,
                            answer: grams,
                            acceptableAnswers: [`${grams}`, `${grams} g`, `${grams} grams`],
                            hint: "There are 1000 grams in 1 kilogram!",
                            explanation: `1 kilogram = 1000 grams\n${kg} kilogram${kg > 1 ? 's' : ''} = ${kg} √ó 1000 = ${grams} grams`
                        };
                    }
                ];
                
                const problem = conversionProblems[Math.floor(Math.random() * conversionProblems.length)]();
                questions.push({
                    ...problem,
                    category: "Geometry & Measurement"
                });
            }

            // Angles (8 questions)
            const angleQuestions = [
                {question: "What type of angle is 90 degrees?", answer: "right", acceptableAnswers: ["right", "right angle", "a right angle"], hint: "This angle looks like the corner of a square!", explanation: "A 90-degree angle is called a right angle. It looks like the corner of a square or rectangle."},
                {question: "What type of angle is less than 90 degrees?", answer: "acute", acceptableAnswers: ["acute", "acute angle", "an acute angle"], hint: "This angle is smaller than a right angle!", explanation: "An acute angle is less than 90 degrees. It's smaller than a right angle."},
                {question: "What type of angle is more than 90 degrees?", answer: "obtuse", acceptableAnswers: ["obtuse", "obtuse angle", "an obtuse angle"], hint: "This angle is larger than a right angle!", explanation: "An obtuse angle is more than 90 degrees but less than 180 degrees."},
                {question: "How many degrees are in a straight line?", answer: 180, acceptableAnswers: ["180", "180 degrees"], hint: "Think of a completely flat line!", explanation: "A straight line has 180 degrees. It's like half a circle."},
                {question: "How many degrees are in a complete turn?", answer: 360, acceptableAnswers: ["360", "360 degrees"], hint: "Think of turning all the way around in a full circle!", explanation: "A complete turn (full circle) has 360 degrees."},
                {question: "What type of angle is exactly 180 degrees?", answer: "straight", acceptableAnswers: ["straight", "straight angle", "a straight angle"], hint: "This angle forms a straight line!", explanation: "A 180-degree angle is called a straight angle because it forms a straight line."},
                {question: "How many degrees are in a right angle?", answer: 90, acceptableAnswers: ["90", "90 degrees"], hint: "Think of the corner of a book or square!", explanation: "A right angle has exactly 90 degrees."},
                {question: "What is half of a right angle in degrees?", answer: 45, acceptableAnswers: ["45", "45 degrees"], hint: "A right angle is 90 degrees, so half is...", explanation: "Half of a right angle is 90 √∑ 2 = 45 degrees."}
            ];
            
            for (let i = 0; i < 8; i++) {
                questions.push({
                    ...angleQuestions[i],
                    category: "Geometry & Measurement"
                });
            }

            // Continue with remaining categories...
            // Fractions & Patterns - 42 questions
            
            // Fraction basics (12 questions)
            for (let i = 0; i < 12; i++) {
                const fractionProblems = [
                    () => {
                        const whole = [8, 12, 16, 20, 24][Math.floor(Math.random() * 5)];
                        return {
                            question: `What is 1/2 of ${whole}?`,
                            answer: whole / 2,
                            hint: "Divide by 2 to find half!",
                            explanation: `1/2 of ${whole} means ${whole} √∑ 2 = ${whole / 2}`
                        };
                    },
                    () => {
                        const whole = [12, 15, 18, 21][Math.floor(Math.random() * 4)];
                        return {
                            question: `What is 1/3 of ${whole}?`,
                            answer: whole / 3,
                            hint: "Divide by 3 to find one third!",
                            explanation: `1/3 of ${whole} means ${whole} √∑ 3 = ${whole / 3}`
                        };
                    },
                    () => {
                        const whole = [16, 20, 24, 28][Math.floor(Math.random() * 4)];
                        return {
                            question: `What is 1/4 of ${whole}?`,
                            answer: whole / 4,
                            hint: "Divide by 4 to find one quarter!",
                            explanation: `1/4 of ${whole} means ${whole} √∑ 4 = ${whole / 4}`
                        };
                    }
                ];
                
                const problem = fractionProblems[Math.floor(Math.random() * fractionProblems.length)]();
                questions.push({
                    ...problem,
                    category: "Fractions & Patterns"
                });
            }

            // Equivalent fractions (10 questions)
            for (let i = 0; i < 10; i++) {
                const equivalentProblems = [
                    () => {
                        return {
                            question: "2/4 = ?/8",
                            answer: 4,
                            hint: "What do you multiply 4 by to get 8? Do the same to the top!",
                            explanation: "2/4 = ?/8\n4 √ó 2 = 8, so 2 √ó 2 = 4\nAnswer: 2/4 = 4/8"
                        };
                    },
                    () => {
                        return {
                            question: "1/2 = ?/10",
                            answer: 5,
                            hint: "What do you multiply 2 by to get 10? Do the same to the top!",
                            explanation: "1/2 = ?/10\n2 √ó 5 = 10, so 1 √ó 5 = 5\nAnswer: 1/2 = 5/10"
                        };
                    },
                    () => {
                        return {
                            question: "3/6 = 1/?",
                            answer: 2,
                            hint: "What do you divide 3 by to get 1? Do the same to the bottom!",
                            explanation: "3/6 = 1/?\n3 √∑ 3 = 1, so 6 √∑ 3 = 2\nAnswer: 3/6 = 1/2"
                        };
                    }
                ];
                
                const problem = equivalentProblems[Math.floor(Math.random() * equivalentProblems.length)]();
                questions.push({
                    ...problem,
                    category: "Fractions & Patterns"
                });
            }

            // Sequences (12 questions)
            for (let i = 0; i < 12; i++) {
                const sequenceProblems = [
                    () => {
                        const start = Math.floor(Math.random() * 10) + 2;
                        const step = Math.floor(Math.random() * 8) + 2;
                        const seq = [start, start + step, start + 2*step];
                        const next1 = start + 3*step;
                        const next2 = start + 4*step;
                        return {
                            question: `Complete the sequence: ${seq.join(', ')}, ?, ?`,
                            answer: `${next1}, ${next2}`,
                            acceptableAnswers: [`${next1}, ${next2}`, `${next1} ${next2}`, `${next1} and ${next2}`],
                            hint: `Look at the pattern - what number is being added each time?`,
                            explanation: `The pattern adds ${step} each time:\n${seq[0]} + ${step} = ${seq[1]}\n${seq[1]} + ${step} = ${seq[2]}\nNext: ${seq[2]} + ${step} = ${next1}\nThen: ${next1} + ${step} = ${next2}`
                        };
                    }
                ];
                
                const problem = sequenceProblems[0]();
                questions.push({
                    ...problem,
                    category: "Fractions & Patterns"
                });
            }

            // Patterns (8 questions)
            for (let i = 0; i < 8; i++) {
                const patternProblems = [
                    () => {
                        const start = 2;
                        const sequence = [2, 4, 8, 16];
                        return {
                            question: "What comes next: 2, 4, 8, 16, ?",
                            answer: 32,
                            hint: "Each number is double the previous number!",
                            explanation: "Each number is multiplied by 2:\n2 √ó 2 = 4\n4 √ó 2 = 8\n8 √ó 2 = 16\n16 √ó 2 = 32"
                        };
                    },
                    () => {
                        const sequence = [1, 4, 9, 16];
                        return {
                            question: "What comes next: 1, 4, 9, 16, ?",
                            answer: 25,
                            hint: "These are square numbers: 1√ó1, 2√ó2, 3√ó3, 4√ó4...",
                            explanation: "These are square numbers:\n1¬≤ = 1\n2¬≤ = 4\n3¬≤ = 9\n4¬≤ = 16\n5¬≤ = 25"
                        };
                    }
                ];
                
                const problem = patternProblems[Math.floor(Math.random() * patternProblems.length)]();
                questions.push({
                    ...problem,
                    category: "Fractions & Patterns"
                });
            }

            // Logic & Reasoning - 33 questions
            
            // Number puzzles (15 questions)
            for (let i = 0; i < 15; i++) {
                const puzzleProblems = [
                    () => {
                        const name = getRandomName();
                        const answer = Math.floor(Math.random() * 15) + 5;
                        const result = answer * 4;
                        return {
                            question: `${name} is thinking of a number. When multiplied by 4, it equals ${result}. What is the number?`,
                            answer: answer,
                            hint: "What number times 4 equals ${result}? Try dividing!",
                            explanation: `Let the number be x\nx √ó 4 = ${result}\nx = ${result} √∑ 4 = ${answer}`
                        };
                    },
                    () => {
                        const name = getRandomName();
                        const answer = Math.floor(Math.random() * 20) + 10;
                        const result = answer + 15;
                        return {
                            question: `${name} thinks of a number and adds 15. The result is ${result}. What was the original number?`,
                            answer: answer,
                            hint: "If adding 15 gives ${result}, what was the original number?",
                            explanation: `Let the number be x\nx + 15 = ${result}\nx = ${result} - 15 = ${answer}`
                        };
                    }
                ];
                
                const problem = puzzleProblems[Math.floor(Math.random() * puzzleProblems.length)]();
                questions.push({
                    ...problem,
                    category: "Logic & Reasoning"
                });
            }

            // Comparisons (10 questions)
            for (let i = 0; i < 10; i++) {
                const comparisonProblems = [
                    () => {
                        return {
                            question: "Which is greater: 3/4 or 2/3?",
                            answer: "3/4",
                            acceptableAnswers: ["3/4", "three quarters", "3 quarters"],
                            hint: "Convert to decimals: 3/4 = 0.75 and 2/3 = 0.67",
                            explanation: "3/4 = 0.75 and 2/3 ‚âà 0.67\nSince 0.75 > 0.67, we have 3/4 > 2/3"
                        };
                    },
                    () => {
                        const a = Math.floor(Math.random() * 400) + 100;
                        const b = Math.floor(Math.random() * 400) + 100;
                        const larger = Math.max(a, b);
                        return {
                            question: `Which is larger: ${a} or ${b}?`,
                            answer: larger,
                            hint: "Compare the numbers digit by digit!",
                            explanation: `Comparing ${a} and ${b}:\n${larger} is larger than ${Math.min(a, b)}`
                        };
                    }
                ];
                
                const problem = comparisonProblems[Math.floor(Math.random() * comparisonProblems.length)]();
                questions.push({
                    ...problem,
                    category: "Logic & Reasoning"
                });
            }

            // Ordering (8 questions)
            for (let i = 0; i < 8; i++) {
                const numbers = [];
                for (let j = 0; j < 4; j++) {
                    numbers.push(Math.floor(Math.random() * 500) + 100);
                }
                const sorted = [...numbers].sort((a, b) => a - b);
                
                questions.push({
                    question: `Order from smallest to largest: ${numbers.join(', ')}`,
                    answer: sorted.join(', '),
                    acceptableAnswers: [sorted.join(', '), sorted.join(' ')],
                    hint: "Start with the smallest number and work your way up!",
                    explanation: `Arranging in order:\n${sorted.join(' < ')}`,
                    category: "Logic & Reasoning"
                });
            }

            // Add unique IDs to all questions that don't have them
            questions.forEach((question, index) => {
                if (!question.id) {
                    const categoryCode = question.category.replace(/[^a-zA-Z]/g, '').toLowerCase().substring(0, 8);
                    question.id = `${categoryCode}_${String(index + 1).padStart(4, '0')}`;
                }
            });
            
            return shuffleArray(questions);
        }

        // Utility function to fix floating point precision errors
        function roundMoney(amount) {
            return Math.round(amount * 100) / 100;
        }

        function roundDecimal(number, decimals = 2) {
            return Math.round(number * Math.pow(10, decimals)) / Math.pow(10, decimals);
        }

        function normalizeMoneyAnswer(answer) {
            if (typeof answer !== 'string') {
                answer = String(answer);
            }
            answer = answer.toLowerCase().trim();
            
            // Handle pence notation (19p, 19 pence)
            if (answer.includes('p') && !answer.includes('¬£')) {
                const penceMatch = answer.match(/(\d+(?:\.\d+)?)/);
                if (penceMatch) {
                    const penceValue = parseFloat(penceMatch[1]);
                    // If it's a whole number > 2, treat as pence
                    if (penceValue > 2 && penceValue === Math.floor(penceValue)) {
                        return (penceValue / 100).toFixed(2);
                    }
                }
            }
            
            // Remove currency symbols
            answer = answer.replace(/[¬£$%¬∞,p]/g, '');
            
            // If it's a number, format to 2 decimal places
            const num = parseFloat(answer);
            if (!isNaN(num)) {
                // If input is integer > 2, treat as pence
                if (num > 2 && num === Math.floor(num) && !answer.includes('.')) {
                    return (num / 100).toFixed(2);
                }
                return num.toFixed(2);
            }
            
            return answer;
        }

        function normalizeAnswer(answer) {
            if (typeof answer !== 'string') {
                answer = String(answer);
            }
            return answer.toLowerCase().trim().replace(/[¬£$%¬∞,]/g, '');
        }

        function checkAnswer(userAnswer, correctAnswer, acceptableAnswers = []) {
            const normalizedUser = normalizeAnswer(userAnswer);
            const normalizedCorrect = normalizeAnswer(correctAnswer);
            
            // Check exact match first
            if (normalizedUser === normalizedCorrect) {
                return true;
            }
            
            // Special handling for money answers (detect decimal amounts < 10)
            if (typeof correctAnswer === 'number' && correctAnswer > 0 && correctAnswer < 10 && correctAnswer.toString().includes('.')) {
                const userMoney = normalizeMoneyAnswer(userAnswer);
                const correctMoney = correctAnswer.toFixed(2);
                const correctPence = Math.round(correctAnswer * 100).toString();
                
                // Accept various formats: 0.19, 19, 19p, ¬£0.19
                if (Math.abs(parseFloat(userMoney) - correctAnswer) < 0.01 || 
                    normalizedUser === correctPence || 
                    normalizedUser === correctPence + 'p') {
                    return true;
                }
            }
            
            // Check for numeric tolerance (for floating point errors)
            const userNum = parseFloat(normalizedUser);
            const correctNum = parseFloat(normalizedCorrect);
            if (!isNaN(userNum) && !isNaN(correctNum)) {
                if (Math.abs(userNum - correctNum) < 0.01) {
                    return true;
                }
            }
            
            // Check acceptable answers
            for (const acceptable of acceptableAnswers) {
                if (normalizedUser === normalizeAnswer(acceptable)) {
                    return true;
                }
                // Also check money normalization for acceptable answers
                if (typeof correctAnswer === 'number' && correctAnswer > 0 && correctAnswer < 10) {
                    const userMoney = normalizeMoneyAnswer(userAnswer);
                    const acceptableMoney = normalizeMoneyAnswer(acceptable);
                    if (Math.abs(parseFloat(userMoney) - parseFloat(acceptableMoney)) < 0.01) {
                        return true;
                    }
                }
            }
            
            return false;
        }

        // Screen Management Functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showUserScreen() {
            populateUserList();
            showScreen('user-screen');
        }

        function showCreateUserModal() {
            console.log('üéØ CREATE USER BUTTON CLICKED!');
            console.log('üìç Function showCreateUserModal() called');
            
            const modal = document.getElementById('createUserModal');
            console.log('üîç Modal element found:', modal);
            console.log('üîç Modal current display:', modal ? modal.style.display : 'MODAL NOT FOUND!');
            
            if (!modal) {
                console.error('‚ùå CRITICAL ERROR: Modal element not found!');
                alert('Error: Modal not found! Please refresh the page.');
                return;
            }
            
            console.log('‚úÖ Modal element exists, proceeding...');
            
            // Reset form completely
            const usernameInput = document.getElementById('newUsername');
            console.log('üîç Username input found:', usernameInput);
            if (usernameInput) {
                usernameInput.value = '';
                console.log('‚úÖ Username input cleared');
            }
            
            // Reset selected avatar
            selectedAvatarInModal = defaultAvatars[0];
            console.log('‚úÖ Avatar reset to:', selectedAvatarInModal);
            
            // Hide error message
            const errorDiv = document.getElementById('username-error');
            if (errorDiv) {
                errorDiv.style.display = 'none';
                console.log('‚úÖ Error message hidden');
            }
            
            // Reset avatar selection UI
            const avatarOptions = document.querySelectorAll('.avatar-option');
            console.log('üîç Found avatar options:', avatarOptions.length);
            avatarOptions.forEach(option => {
                option.classList.remove('selected');
            });
            
            const firstAvatar = document.querySelector('.avatar-option[data-emoji="üöÄ"]');
            if (firstAvatar) {
                firstAvatar.classList.add('selected');
                console.log('‚úÖ First avatar selected');
            }
            
            // SHOW MODAL WITH HIGH PRIORITY
            console.log('üì± Showing modal...');
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.zIndex = '999999';
            modal.style.background = 'rgba(0, 0, 0, 0.7)';
            modal.classList.add('visible');
            
            console.log('üì± Modal display after setting:', modal.style.display);
            console.log('üì± Modal z-index after setting:', modal.style.zIndex);
            
            // Focus on username input with delay
            setTimeout(() => {
                if (usernameInput) {
                    usernameInput.focus();
                    console.log('‚úÖ Username input focused');
                }
            }, 200);
            
            console.log('üéâ Modal should now be visible!');
            console.log('üîç Final modal state - display:', modal.style.display, 'visibility:', getComputedStyle(modal).visibility);
        }
        
        function closeCreateUserModal() {
            console.log('üö™ Closing modal...');
            
            const modal = document.getElementById('createUserModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('visible');
                console.log('‚úÖ Modal hidden');
                
                // Clear form
                const usernameInput = document.getElementById('newUsername');
                if (usernameInput) {
                    usernameInput.value = '';
                }
                
                // Hide error message
                const errorDiv = document.getElementById('username-error');
                if (errorDiv) {
                    errorDiv.style.display = 'none';
                }
                
                console.log('‚úÖ Modal cleanup complete');
            } else {
                console.error('‚ùå Could not find modal to close!');
            }
        }

        function populateUserList() {
            const userList = document.getElementById('user-list');
            userList.innerHTML = '';
            
            if (Object.keys(allUsers).length === 0) {
                userList.innerHTML = `
                    <div style="text-align: center; padding: var(--space-32); color: var(--color-text-secondary);">
                        <div style="font-size: var(--font-size-4xl); margin-bottom: var(--space-16);">üëã</div>
                        <p>No users yet! Create your first profile to get started.</p>
                        <div style="font-size: var(--font-size-sm); margin-top: var(--space-16); padding: var(--space-12); background: var(--color-bg-1); border-radius: var(--radius-base);">
                            üìù <strong>Instructions:</strong><br>
                            1. Click "Create New User" button<br>
                            2. Enter your name<br>
                            3. Choose an avatar<br>
                            4. Click "Create"<br>
                        </div>
                    </div>
                `;
                return;
            }
            
            Object.values(allUsers).forEach(user => {
                const accuracy = user.totalQuestionsAttempted > 0 ? 
                    Math.round((user.totalCorrect / user.totalQuestionsAttempted) * 100) : 0;
                
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.onclick = () => selectUser(user.username);
                
                userCard.innerHTML = `
                    <div class="user-card-avatar">${user.avatar}</div>
                    <div class="user-card-name">${user.username}</div>
                    <div class="user-card-stats">
                        Questions: ${user.totalQuestionsAttempted}<br>
                        Accuracy: ${accuracy}%<br>
                        Last active: ${user.lastActiveDate}
                    </div>
                `;
                
                userList.appendChild(userCard);
            });
        }

        function selectUser(username) {
            currentUser = allUsers[username];
            if (currentUser) {
                currentUser.lastActiveDate = new Date().toLocaleDateString();
                saveUserData();
                showWelcome();
            }
        }



        function createNewUser(username, avatar) {
            console.log('üë• Creating new user:', username, avatar);
            
            currentUser = createUserProfile(username, avatar);
            allUsers[username] = currentUser;
            saveUserData();
            
            console.log('‚úÖ User created successfully:', username);
            console.log('üìä Total users now:', Object.keys(allUsers).length);
            
            return currentUser;
        }
        
        function renderAvatarSelection() {
            console.log('üéÜ Setting up avatar selection...');
            
            const container = document.querySelector('.avatar-selection');
            console.log('üîç Avatar container found:', !!container);
            
            if (!container) {
                console.error('‚ùå Avatar container not found!');
                return;
            }
            
            // Avatar selection is already in HTML, just add event listeners
            const avatars = ['üöÄ', '‚öΩ', 'üé®', 'üåü', 'üéÆ', 'ü¶Ñ', 'üåà', 'üéØ', '‚≠ê', 'üî•', 'üí´', 'üé™', 'üé≠', 'üé¨', 'üé§', 'üèÄ'];
            
            const avatarOptions = container.querySelectorAll('.avatar-option');
            console.log('üîç Found avatar options:', avatarOptions.length);
            
            avatarOptions.forEach((div, index) => {
                console.log(`üéÜ Setting up avatar ${index + 1}:`, div.dataset.emoji);
                
                div.addEventListener('click', function() {
                    console.log('üîò Avatar clicked:', this.dataset.emoji);
                    
                    // Remove selected from all
                    document.querySelectorAll('.avatar-option').forEach(el => {
                        el.classList.remove('selected');
                    });
                    
                    // Add selected to clicked
                    this.classList.add('selected');
                    selectedAvatarInModal = this.dataset.emoji;
                    
                    console.log('‚úÖ Avatar selected:', selectedAvatarInModal);
                });
            });
            
            // Select first avatar by default
            const firstAvatar = container.querySelector('.avatar-option');
            if (firstAvatar) {
                firstAvatar.classList.add('selected');
                selectedAvatarInModal = firstAvatar.dataset.emoji;
                console.log('‚úÖ Default avatar selected:', selectedAvatarInModal);
            }
            
            console.log('‚úÖ Avatar selection setup complete!');
        }

        // Dashboard Functions
        function showDashboard() {
            if (!currentUser) {
                showUserScreen();
                return;
            }
            
            updateDashboard();
            showScreen('dashboard-screen');
        }

        function updateDashboard() {
            // Update user info
            document.getElementById('dash-user-avatar').textContent = currentUser.avatar;
            document.getElementById('dash-user-name').textContent = `${currentUser.username}'s Dashboard`;
            
            // Update overall statistics
            document.getElementById('dash-total-questions').textContent = currentUser.totalQuestionsAttempted;
            const accuracy = currentUser.totalQuestionsAttempted > 0 ? 
                Math.round((currentUser.totalCorrect / currentUser.totalQuestionsAttempted) * 100) : 0;
            document.getElementById('dash-accuracy').textContent = `${accuracy}%`;
            document.getElementById('dash-hints-used').textContent = currentUser.hintsUsed;
            
            // Add enhanced time display for individual user
            const todayTime = getTodayTime(currentUser);
            const weekTime = getWeekTime(currentUser);
            
            // Add time breakdown section before category performance
            const timeBreakdown = document.querySelector('#time-breakdown');
            if (!timeBreakdown) {
                const timeSection = document.createElement('div');
                timeSection.id = 'time-breakdown';
                timeSection.className = 'dashboard-section';
                timeSection.innerHTML = `
                    <h3>üï∞Ô∏è Your Practice Time</h3>
                    <div class="stats">
                        <div class="stat-item">
                            <span class="stat-value">${formatTime(todayTime)}</span>
                            <div class="stat-label">Today</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${formatTime(weekTime)}</span>
                            <div class="stat-label">This Week</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${formatTime(getAverageSessionDuration(currentUser))}</span>
                            <div class="stat-label">Avg Session</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${currentUser.sessions?.length || 0}</span>
                            <div class="stat-label">Total Sessions</div>
                        </div>
                    </div>
                `;
                
                const categorySection = document.querySelector('.dashboard-content .dashboard-section');
                if (categorySection) {
                    categorySection.parentNode.insertBefore(timeSection, categorySection);
                }
            } else {
                // Update existing time breakdown
                const stats = timeBreakdown.querySelectorAll('.stat-value');
                stats[0].textContent = formatTime(todayTime);
                stats[1].textContent = formatTime(weekTime);
                stats[2].textContent = formatTime(getAverageSessionDuration(currentUser));
                stats[3].textContent = currentUser.sessions?.length || 0;
            }
            
            // Format time practiced with enhanced display
            const todayTime = getTodayTime(currentUser);
            const weekTime = getWeekTime(currentUser);
            const totalTime = currentUser.totalTimeSpent;
            
            document.getElementById('dash-time-practiced').textContent = formatTime(totalTime);
            
            // Add motivational message about today's practice
            const motivationalMsg = document.createElement('div');
            motivationalMsg.style.cssText = 'font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-8);';
            if (todayTime > 0) {
                motivationalMsg.textContent = `You practiced ${formatTime(todayTime)} today! Great job! üåü`;
            } else {
                motivationalMsg.textContent = 'Start practicing today to begin your learning streak!';
            }
            
            const timeStatItem = document.getElementById('dash-time-practiced').closest('.stat-item');
            if (timeStatItem && !timeStatItem.querySelector('.motivational-msg')) {
                motivationalMsg.className = 'motivational-msg';
                timeStatItem.appendChild(motivationalMsg);
            }
            
            // Calculate streak
            const streak = calculateStreak();
            document.getElementById('dash-streak').textContent = streak;
            
            // Count achievements
            document.getElementById('dash-achievements').textContent = currentUser.achievements.length;
            
            // Update category performance
            updateCategoryPerformance();
            
            // Update recent sessions
            updateRecentSessions();
            
            // Update mistake count
            document.getElementById('total-mistakes').textContent = currentUser.incorrectQuestions.length;
            
            // Enable/disable practice mistakes button
            const practiceBtn = document.getElementById('practice-mistakes-btn');
            if (practiceBtn) {
                practiceBtn.disabled = currentUser.incorrectQuestions.length === 0;
                practiceBtn.textContent = currentUser.incorrectQuestions.length === 0 ? 
                    'üîÑ No Mistakes to Practice' : 'üîÑ Practice My Mistakes';
            }
            
            // Update achievements
            updateAchievementsDisplay();
        }

        function updateCategoryPerformance() {
            const container = document.getElementById('category-performance');
            container.innerHTML = '';
            
            Object.entries(currentUser.categoryStats).forEach(([category, stats]) => {
                const accuracy = stats.attempted > 0 ? Math.round((stats.correct / stats.attempted) * 100) : 0;
                let scoreClass = 'needs-work';
                if (accuracy >= 80) scoreClass = 'excellent';
                else if (accuracy >= 60) scoreClass = 'good';
                
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-item';
                categoryItem.innerHTML = `
                    <div class="category-name">${category}</div>
                    <div class="category-score ${scoreClass}">${accuracy}% (${stats.correct}/${stats.attempted})</div>
                `;
                container.appendChild(categoryItem);
            });
        }

        function updateRecentSessions() {
            const container = document.getElementById('recent-sessions');
            container.innerHTML = '';
            
            const recentSessions = currentUser.sessions.slice(-10).reverse();
            
            if (recentSessions.length === 0) {
                container.innerHTML = '<p style="color: var(--color-text-secondary); text-align: center;">No sessions yet. Start practicing to see your progress!</p>';
                return;
            }
            
            recentSessions.forEach(session => {
                const accuracy = session.questionsAnswered > 0 ? 
                    Math.round((session.correct / session.questionsAnswered) * 100) : 0;
                const minutes = Math.floor(session.timeSpent / 60);
                const seconds = session.timeSpent % 60;
                
                const sessionItem = document.createElement('div');
                sessionItem.className = 'session-item';
                sessionItem.innerHTML = `
                    <div class="session-info">
                        <strong>${session.mode.charAt(0).toUpperCase() + session.mode.slice(1)} Mode</strong><br>
                        <small>${session.date}</small>
                    </div>
                    <div class="session-stats">
                        ${session.correct}/${session.questionsAnswered} (${accuracy}%)<br>
                        ${minutes}:${seconds.toString().padStart(2, '0')}
                    </div>
                `;
                container.appendChild(sessionItem);
            });
        }

        function calculateStreak() {
            if (currentUser.streakDays.length === 0) return 0;
            
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 24 * 60 * 60 * 1000).toDateString();
            
            let streak = 0;
            const sortedDays = currentUser.streakDays.sort((a, b) => new Date(b) - new Date(a));
            
            // Check if user practiced today or yesterday to maintain streak
            if (sortedDays[0] === today || sortedDays[0] === yesterday) {
                let currentDate = new Date(sortedDays[0]);
                streak = 1;
                
                for (let i = 1; i < sortedDays.length; i++) {
                    const prevDate = new Date(currentDate.getTime() - 24 * 60 * 60 * 1000);
                    if (sortedDays[i] === prevDate.toDateString()) {
                        streak++;
                        currentDate = prevDate;
                    } else {
                        break;
                    }
                }
            }
            
            return streak;
        }

        function updateAchievementsDisplay() {
            const container = document.getElementById('achievements-grid');
            container.innerHTML = '';
            
            Object.entries(achievements).forEach(([key, achievement]) => {
                const isUnlocked = currentUser.achievements.includes(key);
                
                const achievementItem = document.createElement('div');
                achievementItem.className = `achievement-item ${isUnlocked ? 'unlocked' : ''}`;
                achievementItem.innerHTML = `
                    <div class="achievement-icon">${achievement.icon}</div>
                    <div class="achievement-name">${achievement.name}</div>
                    <div class="achievement-desc">${achievement.desc}</div>
                `;
                container.appendChild(achievementItem);
            });
        }

        function showWelcome() {
            if (!currentUser) {
                showUserScreen();
                return;
            }
            
            // Update leaderboards
            updateLeaderboards();
            
            // Update current user display
            document.getElementById('current-user-avatar').textContent = currentUser.avatar;
            document.getElementById('current-user-name').textContent = currentUser.username;
            
            // Show user's rank
            const rankDisplay = document.getElementById('user-rank-display');
            const overallRank = currentUser.leaderboardRanks.overall;
            const totalPoints = currentUser.points.total || 0;
            if (overallRank > 0) {
                const suffix = overallRank === 1 ? 'st ü•á' : overallRank === 2 ? 'nd ü•à' : overallRank === 3 ? 'rd ü•â' : 'th üèÖ';
                rankDisplay.textContent = `Rank: ${overallRank}${suffix} ‚Ä¢ ${totalPoints} points`;
            } else {
                rankDisplay.textContent = 'Start practicing to join the leaderboard!';
            }
            
            showScreen('welcome-screen');
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function startMode(mode) {
            if (!currentUser) {
                showUserScreen();
                return;
            }
            
            currentMode = mode;
            isMistakeMode = false;
            questionBank = generateQuestionBank();
            
            if (mode === 'challenge') {
                questionBank = shuffleArray(questionBank).slice(0, 15);
                timeRemaining = 20 * 60; // 20 minutes in seconds
                startTimer();
            }
            
            currentQuestionIndex = 0;
            score = 0;
            totalQuestions = 0;
            hintsUsed = 0;
            sessionQuestions = [];
            startTime = Date.now();
            sessionPoints = 0;
            sessionPointsEarned = [];
            perfectStreak = 0;
            consecutiveCorrect = 0;
            
            showQuestion();
            showScreen('question-screen');
        }

        function startMistakeMode() {
            if (!currentUser || currentUser.incorrectQuestions.length === 0) {
                alert('No mistakes to review! Keep practicing and come back later.');
                return;
            }
            
            currentMode = 'practice';
            isMistakeMode = true;
            
            // Create question bank from incorrect questions
            questionBank = currentUser.incorrectQuestions.map(mistake => ({
                question: mistake.questionText,
                answer: mistake.correctAnswer,
                acceptableAnswers: mistake.acceptableAnswers || [],
                hint: mistake.hint || 'Think step by step!',
                explanation: mistake.explanation || 'Review the solution carefully.',
                category: mistake.category || 'Review',
                id: mistake.questionId
            }));
            
            questionBank = shuffleArray(questionBank);
            
            currentQuestionIndex = 0;
            score = 0;
            totalQuestions = 0;
            hintsUsed = 0;
            sessionQuestions = [];
            startTime = Date.now();
            
            showQuestion();
            showScreen('question-screen');
        }

        function startTimer() {
            const timerDisplay = document.getElementById('timer-display');
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerDisplay.textContent = `‚è∞ ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (timeRemaining <= 300) { // 5 minutes
                    timerDisplay.className = 'timer warning';
                } else if (timeRemaining <= 120) { // 2 minutes
                    timerDisplay.className = 'timer danger';
                }
                
                if (timeRemaining <= 0) {
                    finishSession();
                }
            }, 1000);
        }

        function showQuestion() {
            if (currentQuestionIndex >= questionBank.length) {
                finishSession();
                return;
            }
            
            const question = questionBank[currentQuestionIndex];
            
            document.getElementById('question-text').textContent = question.question;
            document.getElementById('answer-input').value = '';
            document.getElementById('answer-input').focus();
            
            // Update progress
            const questionCounter = document.getElementById('question-counter');
            if (currentMode === 'challenge') {
                questionCounter.textContent = `Question ${currentQuestionIndex + 1} of 15`;
            } else {
                questionCounter.textContent = `Question ${currentQuestionIndex + 1}`;
            }
            
            // Update score
            const percentage = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
            document.getElementById('score-display').textContent = `Score: ${score}/${totalQuestions} (${percentage}%)`;
            
            // Reset UI
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('hint-btn').style.display = 'inline-block';
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('finish-btn').style.display = currentMode === 'practice' ? 'inline-block' : 'none';
            document.getElementById('hint-container').innerHTML = '';
            document.getElementById('feedback-container').innerHTML = '';
            document.getElementById('explanation-container').innerHTML = '';
            
            isAnswered = false;
            currentHintShown = false;
            
            // Update hints counter
            document.getElementById('hints-used').textContent = `Hints used: ${hintsUsed}`;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                const submitBtn = document.getElementById('submit-btn');
                if (!submitBtn.disabled) {
                    submitAnswer();
                }
            }
        }

        // Enable submit button when answer is entered
        document.addEventListener('DOMContentLoaded', function() {
            const answerInput = document.getElementById('answer-input');
            if (answerInput) {
                answerInput.addEventListener('input', function() {
                    const submitBtn = document.getElementById('submit-btn');
                    submitBtn.disabled = this.value.trim() === '';
                });
            }
        });

        function showHint() {
            if (currentHintShown) return;
            
            const question = questionBank[currentQuestionIndex];
            const hintContainer = document.getElementById('hint-container');
            
            hintContainer.innerHTML = `
                <div class="hint">
                    <strong>üí° Hint:</strong> ${question.hint}
                </div>
            `;
            
            hintsUsed++;
            currentHintShown = true;
            document.getElementById('hint-btn').style.display = 'none';
            document.getElementById('hints-used').textContent = `Hints used: ${hintsUsed}`;
        }

        function submitAnswer() {
            if (isAnswered) return;
            
            const userAnswer = document.getElementById('answer-input').value.trim();
            const question = questionBank[currentQuestionIndex];
            const isCorrect = checkAnswer(userAnswer, question.answer, question.acceptableAnswers || []);
            
            totalQuestions++;
            if (isCorrect) {
                score++;
            }
            
            // Track question details for session recording
            const questionId = question.id;
            const questionDetails = {
                questionId: questionId,
                questionText: question.question,
                correctAnswer: question.answer,
                userAnswer: userAnswer,
                isCorrect: isCorrect,
                category: question.category,
                hintUsed: currentHintShown,
                timeSpent: Math.floor((Date.now() - startTime) / 1000) // rough estimate
            };
            
            sessionQuestions.push(questionDetails);
            
            // Calculate and award points
            const pointsEarned = calculatePoints(questionDetails);
            if (pointsEarned > 0) {
                sessionPoints += pointsEarned;
                showPointsEarned(pointsEarned);
            }
            
            // If incorrect and not in mistake mode, add to incorrect questions
            if (!isCorrect && !isMistakeMode) {
                addToIncorrectQuestions(questionDetails);
            }
            
            // If correct and in mistake mode, remove from incorrect questions
            if (isCorrect && isMistakeMode) {
                removeFromIncorrectQuestions(questionId);
                // Award retry correction points
                sessionPoints += POINTS.retry_correction;
            }
            
            // Show feedback
            const feedbackContainer = document.getElementById('feedback-container');
            const encouragement = isCorrect ? 
                ['Excellent! üåü', 'Well done! üéâ', 'Correct! üëè', 'Brilliant! ‚ú®', 'Perfect! üéØ'][Math.floor(Math.random() * 5)] :
                ['Not quite right üòä', 'Good try! üí™', 'Keep trying! üåü', 'Almost there! üëç'][Math.floor(Math.random() * 4)];
            
            feedbackContainer.innerHTML = `
                <div class="feedback ${isCorrect ? 'correct' : 'incorrect'}">
                    <strong>${isCorrect ? '‚úì' : '‚úó'} ${encouragement}</strong>
                    ${!isCorrect ? `<br>The correct answer is: <strong>${question.answer}</strong>` : ''}
                </div>
            `;
            
            // Show explanation
            const explanationContainer = document.getElementById('explanation-container');
            explanationContainer.innerHTML = `
                <div class="explanation">
                    <h4>üìñ Explanation:</h4>
                    <p>${question.explanation.replace(/\n/g, '<br>')}</p>
                </div>
            `;
            
            // Update UI
            document.getElementById('submit-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'inline-block';
            document.getElementById('hint-btn').style.display = 'none';
            document.getElementById('answer-input').disabled = true;
            
            // Update score display
            const percentage = Math.round((score / totalQuestions) * 100);
            document.getElementById('score-display').textContent = `Score: ${score}/${totalQuestions} (${percentage}%)`;
            
            isAnswered = true;
        }

        function nextQuestion() {
            currentQuestionIndex++;
            document.getElementById('answer-input').disabled = false;
            
            if (currentMode === 'challenge' && currentQuestionIndex >= 15) {
                finishSession();
            } else {
                showQuestion();
            }
        }

        function finishSession() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            const endTime = Date.now();
            const timeTaken = Math.floor((endTime - startTime) / 1000);
            const minutes = Math.floor(timeTaken / 60);
            const seconds = timeTaken % 60;
            
            // Calculate final stats
            const percentage = totalQuestions > 0 ? Math.round((score / totalQuestions) * 100) : 0;
            
            // Record session and update user stats
            if (currentUser && totalQuestions > 0) {
                // Store previous ranks for change tracking
                currentUser.previousRanks = { ...currentUser.leaderboardRanks };
                
                recordSession(timeTaken, percentage);
                updateUserStats();
                checkForNewAchievements();
                updateLeaderboards();
                saveUserData();
                
                // Show leaderboard changes
                showLeaderboardChanges();
            }
            
            // Update results screen
            document.getElementById('final-score').textContent = `${score}/${totalQuestions}`;
            document.getElementById('final-percentage').textContent = `${percentage}%`;
            document.getElementById('final-hints').textContent = hintsUsed;
            document.getElementById('final-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Show session points earned
            if (sessionPoints > 0) {
                document.getElementById('final-message').innerHTML += `
                    <div style="background: var(--color-bg-3); border-radius: var(--radius-base); padding: var(--space-16); margin: var(--space-16) 0;">
                        <div style="font-size: var(--font-size-xl); color: var(--app-success); font-weight: var(--font-weight-bold);">+${sessionPoints} Points Earned! ‚≠ê</div>
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: var(--space-4);">Total Points: ${currentUser.points.total}</div>
                    </div>
                `;
            }
            
            // Set celebration and message based on performance
            let celebration = 'üéâ';
            let message = '';
            
            if (percentage >= 90) {
                celebration = 'üèÜüåüüéâ';
                message = 'Outstanding! You\'re a maths superstar!';
            } else if (percentage >= 80) {
                celebration = 'üåüüéâ';
                message = 'Excellent work! You\'re doing brilliantly!';
            } else if (percentage >= 70) {
                celebration = 'üéâüëè';
                message = 'Great job! Keep up the good work!';
            } else if (percentage >= 60) {
                celebration = 'üëçüí™';
                message = 'Good effort! You\'re improving!';
            } else {
                celebration = 'üí™üåü';
                message = 'Keep practicing! You\'re learning!';
            }
            
            document.getElementById('celebration-emoji').textContent = celebration;
            document.getElementById('final-message').innerHTML = `<p style="font-size: var(--font-size-lg); color: var(--color-text); margin: var(--space-16) 0;">${message}</p>`;
            
            // Save best score
            saveBestScore(currentMode, score, totalQuestions, percentage, timeTaken, hintsUsed);
            
            // Show any new achievements
            showSessionAchievements();
            
            showScreen('results-screen');
        }

        function confirmQuit() {
            if (confirm('Are you sure you want to go back to the menu? Your progress will be lost.')) {
                showWelcome();
            }
        }

        // Session recording and user stat functions
        function recordSession(timeTaken, percentage) {
            const now = new Date();
            
            // Award session completion bonuses
            if (currentMode === 'challenge') {
                sessionPoints += POINTS.challenge_completion;
                
                // Speed bonus for challenge mode (under 15 minutes)
                if (timeTaken < 900) {
                    sessionPoints += POINTS.speed_bonus;
                    showPointsEarned(POINTS.speed_bonus, 'Speed demon bonus! ‚ö°');
                }
            }
            
            // Perfect session bonus
            if (percentage === 100 && totalQuestions >= 5) {
                sessionPoints += POINTS.perfect_session;
                showPointsEarned(POINTS.perfect_session, 'Perfect session! üèÜ');
            }
            
            // Daily streak bonus
            const today = new Date().toDateString();
            if (!currentUser.streakDays.includes(today)) {
                sessionPoints += POINTS.daily_streak;
                currentUser.streakDays.push(today);
            }
            
            // Update user points
            if (!currentUser.points) {
                currentUser.points = { total: 0, thisWeek: 0, lastWeek: 0 };
            }
            currentUser.points.total = (currentUser.points.total || 0) + sessionPoints;
            currentUser.points.thisWeek = (currentUser.points.thisWeek || 0) + sessionPoints;
            
            const session = {
                date: now.toLocaleDateString(),
                startTime: startTime,
                endTime: Date.now(),
                durationSeconds: timeTaken,
                mode: isMistakeMode ? 'mistakes' : currentMode,
                questionsAnswered: totalQuestions,
                correct: score,
                incorrect: totalQuestions - score,
                hintsUsed: hintsUsed,
                timeSpent: timeTaken,
                pointsEarned: sessionPoints,
                questions: sessionQuestions
            };
            
            currentUser.sessions.push(session);
            
            // Update time tracking
            updateTimeTracking(timeTaken, now);
            
            // Keep only last 50 sessions
            if (currentUser.sessions.length > 50) {
                currentUser.sessions = currentUser.sessions.slice(-50);
            }
        }
        
        function updateUserStats() {
            currentUser.totalQuestionsAttempted += totalQuestions;
            currentUser.totalCorrect += score;
            currentUser.totalIncorrect += (totalQuestions - score);
            currentUser.hintsUsed += hintsUsed;
            currentUser.totalTimeSpent += Math.floor((Date.now() - startTime) / 1000);
            currentUser.lastActiveDate = new Date().toLocaleDateString();
            
            // Update category stats
            sessionQuestions.forEach(q => {
                if (currentUser.categoryStats[q.category]) {
                    currentUser.categoryStats[q.category].attempted++;
                    if (q.isCorrect) {
                        currentUser.categoryStats[q.category].correct++;
                    }
                }
            });
        }
        
        function addToIncorrectQuestions(questionDetails) {
            // Check if question already exists
            const existingIndex = currentUser.incorrectQuestions.findIndex(
                q => q.questionId === questionDetails.questionId
            );
            
            if (existingIndex >= 0) {
                // Update existing entry
                currentUser.incorrectQuestions[existingIndex].timesAttempted++;
                currentUser.incorrectQuestions[existingIndex].timesIncorrect++;
                currentUser.incorrectQuestions[existingIndex].lastAttemptDate = new Date().toLocaleDateString();
            } else {
                // Add new entry
                currentUser.incorrectQuestions.push({
                    questionId: questionDetails.questionId,
                    questionText: questionDetails.questionText,
                    correctAnswer: questionDetails.correctAnswer,
                    userAnswer: questionDetails.userAnswer,
                    category: questionDetails.category,
                    attemptedDate: new Date().toLocaleDateString(),
                    lastAttemptDate: new Date().toLocaleDateString(),
                    timesAttempted: 1,
                    timesIncorrect: 1,
                    hint: questionBank[currentQuestionIndex].hint,
                    explanation: questionBank[currentQuestionIndex].explanation,
                    acceptableAnswers: questionBank[currentQuestionIndex].acceptableAnswers
                });
            }
            
            // Keep only last 100 unique questions
            if (currentUser.incorrectQuestions.length > 100) {
                currentUser.incorrectQuestions = currentUser.incorrectQuestions.slice(-100);
            }
        }
        
        function removeFromIncorrectQuestions(questionId) {
            currentUser.incorrectQuestions = currentUser.incorrectQuestions.filter(
                q => q.questionId !== questionId
            );
        }
        
        function checkForNewAchievements() {
            const newAchievements = [];
            
            // First Steps
            if (currentUser.totalQuestionsAttempted >= 10 && !currentUser.achievements.includes('firstSteps')) {
                currentUser.achievements.push('firstSteps');
                newAchievements.push(achievements.firstSteps);
            }
            
            // Century Club
            if (currentUser.totalQuestionsAttempted >= 100 && !currentUser.achievements.includes('centuryClub')) {
                currentUser.achievements.push('centuryClub');
                newAchievements.push(achievements.centuryClub);
            }
            
            // Speed Demon (Challenge under 15 minutes)
            if (currentMode === 'challenge' && Math.floor((Date.now() - startTime) / 1000) < 900 && !currentUser.achievements.includes('speedDemon')) {
                currentUser.achievements.push('speedDemon');
                newAchievements.push(achievements.speedDemon);
            }
            
            // No Hints Master
            const sessionsWithoutHints = currentUser.sessions.filter(s => s.hintsUsed === 0 && s.questionsAnswered >= 5).length;
            if (sessionsWithoutHints >= 4 && !currentUser.achievements.includes('noHints')) {
                currentUser.achievements.push('noHints');
                newAchievements.push(achievements.noHints);
            }
            
            // Math Wizard (90% accuracy over 50+ questions)
            if (currentUser.totalQuestionsAttempted >= 50) {
                const accuracy = (currentUser.totalCorrect / currentUser.totalQuestionsAttempted) * 100;
                if (accuracy >= 90 && !currentUser.achievements.includes('mathWizard')) {
                    currentUser.achievements.push('mathWizard');
                    newAchievements.push(achievements.mathWizard);
                }
            }
            
            // Streak Master
            const streak = calculateStreak();
            if (streak >= 7 && !currentUser.achievements.includes('streakMaster')) {
                currentUser.achievements.push('streakMaster');
                newAchievements.push(achievements.streakMaster);
            }
            
            return newAchievements;
        }
        
        function showSessionAchievements() {
            // This would show any achievements unlocked during the session
            const container = document.getElementById('session-achievements');
            container.innerHTML = '';
            
            // For now, just a placeholder - could be enhanced to show actual new achievements
        }

        // In-memory best scores storage
        let bestScores = {
            practice: [],
            challenge: []
        };

        function saveBestScore(mode, score, total, percentage, time, hints) {
            if (!bestScores[mode]) {
                bestScores[mode] = [];
            }
            
            bestScores[mode].push({
                score,
                total,
                percentage,
                time,
                hints,
                date: new Date().toLocaleDateString()
            });
            
            // Keep only the best 5 scores
            bestScores[mode].sort((a, b) => b.percentage - a.percentage);
            bestScores[mode] = bestScores[mode].slice(0, 5);
        }

        function showBestScores() {
            const container = document.getElementById('scores-container');
            let html = '';
            
            ['practice', 'challenge'].forEach(mode => {
                html += `<h3 style="color: var(--app-primary); margin: var(--space-24) 0 var(--space-16) 0; text-transform: capitalize;">${mode} Mode Best Scores</h3>`;
                
                if (bestScores[mode] && bestScores[mode].length > 0) {
                    html += '<div class="stats">';
                    bestScores[mode].forEach((score, index) => {
                        const minutes = Math.floor(score.time / 60);
                        const seconds = score.time % 60;
                        html += `
                            <div class="stat-item">
                                <span class="stat-value">${score.percentage}%</span>
                                <div class="stat-label">
                                    ${score.score}/${score.total} correct<br>
                                    ${minutes}:${seconds.toString().padStart(2, '0')} time<br>
                                    ${score.hints} hints<br>
                                    <small>${score.date}</small>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += '<p style="color: var(--color-text-secondary); font-style: italic;">No scores yet! Play some games to see your best scores here.</p>';
                }
            });
            
            container.innerHTML = html;
            showScreen('scores-screen');
        }

        // Leaderboard Functions
        function showLeaderboard() {
            if (!currentUser) {
                showUserScreen();
                return;
            }
            
            updateLeaderboards();
            showLeaderboardTab('overall');
            showScreen('leaderboard-screen');
        }
        
        function showLeaderboardTab(tabName) {
            currentLeaderboardTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabName) {
                    btn.classList.add('active');
                }
            });
            
            // Show appropriate leaderboard
            const content = document.getElementById('leaderboard-content');
            
            switch(tabName) {
                case 'overall':
                    renderLeaderboard(leaderboards.overall, 'Points', 'overall');
                    break;
                case 'weekly':
                    renderLeaderboard(leaderboards.weekly, 'Points This Week', 'weekly');
                    break;
                case 'accuracy':
                    renderLeaderboard(leaderboards.accuracy, 'Accuracy', 'accuracy');
                    break;
                case 'time':
                    renderLeaderboard(leaderboards.practiceTime, 'Practice Time', 'time');
                    break;
                case 'improvement':
                    renderLeaderboard(leaderboards.improvement, 'Improvement', 'improvement');
                    break;
                case 'streak':
                    renderLeaderboard(leaderboards.streak, 'Streak', 'streak');
                    break;
                case 'champions':
                    renderCategoryChampions();
                    break;
            }
        }
        
        function renderLeaderboard(data, statLabel, type) {
            const content = document.getElementById('leaderboard-content');
            let html = '';
            
            if (data.length === 0) {
                html = `
                    <div style="text-align: center; padding: var(--space-48); color: var(--color-text-secondary);">
                        <div style="font-size: var(--font-size-4xl); margin-bottom: var(--space-16);">üèÜ</div>
                        <p>No data yet! Start practicing to appear on the leaderboard.</p>
                    </div>
                `;
            } else {
                html = `
                    <div class="leaderboard-table">
                        <div class="leaderboard-header">
                            <div>Rank</div>
                            <div>Player</div>
                            <div>${statLabel}</div>
                            <div>Change</div>
                        </div>
                `;
                
                // Show top 10 or all if less than 10
                const displayData = data.slice(0, 10);
                
                // Find current user position if not in top 10
                const userPosition = data.findIndex(entry => entry.username === currentUser.username);
                const showUserPosition = userPosition >= 10;
                
                displayData.forEach((entry, index) => {
                    const isCurrentUser = entry.username === currentUser.username;
                    html += renderLeaderboardRow(entry, isCurrentUser);
                });
                
                // Show current user position if not in top 10
                if (showUserPosition) {
                    html += `<div style="text-align: center; padding: var(--space-12); color: var(--color-text-secondary); font-style: italic;">...</div>`;
                    const userEntry = data[userPosition];
                    html += renderLeaderboardRow(userEntry, true);
                }
                
                html += '</div>';
                
                // Show motivational message
                html += getMotivationalMessage(type, userPosition);
                
                // Show next rank info
                if (userPosition >= 0 && userPosition < data.length - 1) {
                    const nextEntry = data[userPosition - 1];
                    const currentEntry = data[userPosition];
                    const gap = nextEntry.points - currentEntry.points;
                    if (gap > 0) {
                        html += `
                            <div class="next-rank-info">
                                <strong>${gap} ${type === 'accuracy' ? 'more correct answers' : type === 'time' ? 'more practice time' : type === 'streak' ? 'more days' : 'points'} needed to reach ${nextEntry.rank}${getRankSuffix(nextEntry.rank)} place!</strong><br>
                                <small>Keep practicing! üí™</small>
                            </div>
                        `;
                    }
                }
            }
            
            content.innerHTML = html;
        }
        
        function renderLeaderboardRow(entry, isCurrentUser = false) {
            const rankClass = entry.rank === 1 ? 'rank-1' : entry.rank === 2 ? 'rank-2' : entry.rank === 3 ? 'rank-3' : 'rank-other';
            const changeClass = entry.change === 'up' ? 'rank-up' : entry.change === 'down' ? 'rank-down' : entry.change === 'new' ? 'rank-new' : 'rank-same';
            const changeIcon = entry.change === 'up' ? '‚Üë' : entry.change === 'down' ? '‚Üì' : entry.change === 'new' ? 'üÜï' : '‚Üí';
            
            const medal = entry.rank === 1 ? 'ü•á' : entry.rank === 2 ? 'ü•à' : entry.rank === 3 ? 'ü•â' : 'üèÖ';
            
            return `
                <div class="leaderboard-row ${isCurrentUser ? 'current-user' : ''}">
                    <div class="rank-display ${rankClass}">
                        ${medal} ${entry.rank}
                    </div>
                    <div class="player-info">
                        <div class="player-avatar">${entry.avatar}</div>
                        <div class="player-name">${entry.username}${isCurrentUser ? ' (You)' : ''}</div>
                    </div>
                    <div class="player-stats">${entry.displayValue || entry.points}</div>
                    <div class="progress-indicator">
                        <span class="rank-change ${changeClass}">${changeIcon}</span>
                    </div>
                </div>
            `;
        }
        
        function renderCategoryChampions() {
            const content = document.getElementById('leaderboard-content');
            let html = '<div class="category-champions">';
            
            Object.entries(leaderboards.categories).forEach(([category, champions]) => {
                const categoryEmojis = {
                    'Word Problems': 'üìù',
                    'Basic Arithmetic': '‚ûï',
                    'Advanced Arithmetic': 'üßÆ',
                    'Geometry & Measurement': 'üìè',
                    'Fractions & Patterns': 'üî¢',
                    'Logic & Reasoning': 'üß©'
                };
                
                html += `
                    <div class="champion-card">
                        <div class="champion-category">${categoryEmojis[category] || 'üéÜ'} ${category}</div>
                `;
                
                if (champions.length > 0) {
                    champions.forEach((champion, index) => {
                        const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                        html += `
                            <div class="champion-player">
                                ${medal} ${champion.avatar} ${champion.username}
                            </div>
                            <div class="champion-stats">${champion.accuracy}% (${champion.attempted} questions)</div>
                        `;
                        if (index < champions.length - 1) html += '<hr style="margin: var(--space-8) 0; border: 1px solid var(--color-border);">';
                    });
                } else {
                    html += '<div style="color: var(--color-text-secondary); font-style: italic;">No champions yet!</div>';
                }
                
                html += '</div>';
            });
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        function getMotivationalMessage(type, userPosition) {
            if (userPosition === -1) {
                return '<div class="motivational-message">Start practicing to join the leaderboard! üéÜ</div>';
            }
            
            let message = '';
            if (userPosition === 0) {
                message = 'You\'re the champion! üëë';
            } else if (userPosition < 3) {
                message = 'Almost there! Keep pushing! üåü';
            } else if (userPosition < 10) {
                message = 'You\'re in the top 10! Great work! ‚≠ê';
            } else {
                const pointsToTop10 = 'Keep going to reach the top 10! üí™';
                message = pointsToTop10;
            }
            
            return `<div class="motivational-message">${message}</div>`;
        }
        
        function getRankSuffix(rank) {
            if (rank % 10 === 1 && rank !== 11) return 'st';
            if (rank % 10 === 2 && rank !== 12) return 'nd';
            if (rank % 10 === 3 && rank !== 13) return 'rd';
            return 'th';
        }
        
        function showLeaderboardChanges() {
            // This could show notifications about rank changes after a session
            const currentRank = currentUser.leaderboardRanks.overall;
            const previousRank = currentUser.previousRanks.overall || 0;
            
            if (currentRank > 0 && previousRank > 0 && currentRank !== previousRank) {
                let changeMessage = '';
                if (currentRank < previousRank) {
                    changeMessage = `You moved up from ${previousRank}${getRankSuffix(previousRank)} to ${currentRank}${getRankSuffix(currentRank)} place! üéâ`;
                } else {
                    changeMessage = `You moved down from ${previousRank}${getRankSuffix(previousRank)} to ${currentRank}${getRankSuffix(currentRank)} place. Keep practicing! üí™`;
                }
                
                setTimeout(() => {
                    showPointsEarned(0, changeMessage);
                }, 1000);
            }
        }
        
        // Additional UI Functions
        function showMistakesList() {
            const container = document.getElementById('mistakes-list');
            container.innerHTML = '';
            
            if (currentUser.incorrectQuestions.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">No mistakes to review! Great job! üéÜ</p>';
            } else {
                currentUser.incorrectQuestions.forEach((mistake, index) => {
                    const mistakeItem = document.createElement('div');
                    mistakeItem.className = 'mistake-item';
                    mistakeItem.innerHTML = `
                        <div class="mistake-question">${mistake.questionText}</div>
                        <div class="mistake-details">
                            <strong>Correct Answer:</strong> ${mistake.correctAnswer}<br>
                            <strong>Your Answer:</strong> ${mistake.userAnswer}<br>
                            <strong>Category:</strong> ${mistake.category}<br>
                            <strong>Times Attempted:</strong> ${mistake.timesAttempted}<br>
                            <small>Last attempted: ${mistake.lastAttemptDate}</small>
                        </div>
                    `;
                    container.appendChild(mistakeItem);
                });
            }
            
            showScreen('mistakes-screen');
        }
        
        function clearMistakes() {
            if (confirm('Are you sure you want to clear all your mistakes? This cannot be undone.')) {
                currentUser.incorrectQuestions = [];
                saveUserData();
                showDashboard();
            }
        }
        
        function showParentDashboard() {
            if (!parentAccessGranted) {
                requestParentAccess();
                return;
            }
            
            const container = document.getElementById('parent-dashboard-content');
            container.innerHTML = '';
            
            if (Object.keys(allUsers).length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary);">No users to display.</p>';
            } else {
                // Screen Time Tracker Section
                const timeSection = document.createElement('div');
                timeSection.className = 'dashboard-section';
                timeSection.innerHTML = '<h3>üì± Screen Time Summary</h3>';
                
                // Today's summary
                const todayTable = createTimeTable('Today', 'today');
                timeSection.appendChild(todayTable);
                
                // This week's summary
                const weekTable = createTimeTable('This Week', 'week');
                timeSection.appendChild(weekTable);
                
                // All time summary
                const allTimeTable = createTimeTable('All Time', 'allTime');
                timeSection.appendChild(allTimeTable);
                
                container.appendChild(timeSection);
                
                // Export button
                const exportSection = document.createElement('div');
                exportSection.innerHTML = `
                    <div class="button-group" style="margin: var(--space-24) 0;">
                        <button class="btn btn-secondary" onclick="exportTimeReport()">üìä Export Time Report</button>
                        <button class="btn btn-secondary" onclick="exitParentView()">üö™ Exit Parent View</button>
                    </div>
                `;
                container.appendChild(exportSection);
                
                // User overview grid
                const userGrid = document.createElement('div');
                userGrid.className = 'parent-user-grid';
                
                Object.values(allUsers).forEach(user => {
                    const accuracy = user.totalQuestionsAttempted > 0 ? 
                        Math.round((user.totalCorrect / user.totalQuestionsAttempted) * 100) : 0;
                    const todayTime = getTodayTime(user);
                    const weekTime = getWeekTime(user);
                    const avgSession = getAverageSessionDuration(user);
                    
                    const userCard = document.createElement('div');
                    userCard.className = 'parent-user-card';
                    userCard.innerHTML = `
                        <div class="parent-user-header">
                            <div class="user-avatar">${user.avatar}</div>
                            <div>
                                <h3>${user.username}</h3>
                                <small>Last active: ${user.lastActiveDate}</small>
                            </div>
                        </div>
                        <div class="stats">
                            <div class="stat-item">
                                <span class="stat-value">${formatTime(todayTime)}</span>
                                <div class="stat-label">Today</div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${formatTime(weekTime)}</span>
                                <div class="stat-label">This Week</div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${accuracy}%</span>
                                <div class="stat-label">Accuracy</div>
                            </div>
                            <div class="stat-item">
                                <span class="stat-value">${formatTime(avgSession)}</span>
                                <div class="stat-label">Avg Session</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(accuracy, 100)}%;"></div>
                        </div>
                    `;
                    userGrid.appendChild(userCard);
                });
                
                container.appendChild(userGrid);
            }
            
            showScreen('parent-dashboard-screen');
        }
        
        function exportUserData() {
            if (!currentUser) return;
            
            const data = {
                user: currentUser,
                exportDate: new Date().toISOString(),
                version: '1.3'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentUser.username}_math_progress.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function exportAllData() {
            const data = {
                users: allUsers,
                exportDate: new Date().toISOString(),
                version: '1.3'
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `all_math_users_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function showImportData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.users) {
                                // Importing all users
                                Object.assign(allUsers, data.users);
                            } else if (data.user) {
                                // Importing single user
                                allUsers[data.user.username] = data.user;
                            }
                            saveUserData();
                            alert('Data imported successfully!');
                            showParentDashboard();
                        } catch (error) {
                            alert('Error importing data: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }
        
        function showPauseMenu() {
            const options = [
                'Resume',
                'View My Progress', 
                'Switch User',
                'Quit to Menu'
            ];
            
            const choice = prompt(`Game Paused\n\nChoose an option:\n1. Resume\n2. View My Progress\n3. Switch User\n4. Quit to Menu\n\nEnter 1, 2, 3, or 4:`);
            
            switch(choice) {
                case '1':
                    // Just resume - do nothing
                    break;
                case '2':
                    showDashboard();
                    break;
                case '3':
                    if (confirm('Your current session will be lost. Continue?')) {
                        showUserScreen();
                    }
                    break;
                case '4':
                    confirmQuit();
                    break;
                default:
                    // Invalid choice or cancel - resume
                    break;
            }
        }
        
        // Time Tracking Functions
        function updateTimeTracking(timeTaken, date) {
            const today = date.toDateString();
            const week = getWeekKey(date);
            const month = getMonthKey(date);
            
            // Update daily time
            if (!currentUser.dailyTime[today]) {
                currentUser.dailyTime[today] = 0;
            }
            currentUser.dailyTime[today] += timeTaken;
            
            // Update weekly time
            if (!currentUser.weeklyTime[week]) {
                currentUser.weeklyTime[week] = 0;
            }
            currentUser.weeklyTime[week] += timeTaken;
            
            // Update monthly time
            if (!currentUser.monthlyTime[month]) {
                currentUser.monthlyTime[month] = 0;
            }
            currentUser.monthlyTime[month] += timeTaken;
        }
        
        function getTodayTime(user) {
            const today = new Date().toDateString();
            return user.dailyTime?.[today] || 0;
        }
        
        function getWeekTime(user) {
            const thisWeek = getWeekKey(new Date());
            return user.weeklyTime?.[thisWeek] || 0;
        }
        
        function getMonthTime(user) {
            const thisMonth = getMonthKey(new Date());
            return user.monthlyTime?.[thisMonth] || 0;
        }
        
        function getAverageSessionDuration(user) {
            if (!user.sessions || user.sessions.length === 0) return 0;
            const totalTime = user.sessions.reduce((sum, session) => sum + (session.timeSpent || 0), 0);
            return Math.round(totalTime / user.sessions.length);
        }
        
        function formatTime(seconds) {
            if (seconds < 60) return `${seconds} sec`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            if (minutes < 60) {
                return remainingSeconds > 0 ? `${minutes}m ${remainingSeconds}s` : `${minutes} min`;
            }
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            return remainingMinutes > 0 ? `${hours}h ${remainingMinutes}m` : `${hours}h`;
        }
        
        function getWeekKey(date) {
            const year = date.getFullYear();
            const week = getWeekNumber(date);
            return `${year}-W${week}`;
        }
        
        function getMonthKey(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            return `${year}-${month.toString().padStart(2, '0')}`;
        }
        
        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }
        
        function createTimeTable(title, period) {
            const table = document.createElement('div');
            table.innerHTML = `<h4 style="margin: var(--space-16) 0; color: var(--color-primary);">${title} (${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}):</h4>`;
            
            const tableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin-bottom: var(--space-24);">
                    <thead>
                        <tr style="background: var(--color-bg-1); border-bottom: 2px solid var(--color-border);">
                            <th style="padding: var(--space-12); text-align: left; border: 1px solid var(--color-border);">User</th>
                            <th style="padding: var(--space-12); text-align: center; border: 1px solid var(--color-border);">Time ${title}</th>
                            <th style="padding: var(--space-12); text-align: center; border: 1px solid var(--color-border);">Sessions</th>
                            ${period === 'allTime' ? '<th style="padding: var(--space-12); text-align: center; border: 1px solid var(--color-border);">Avg/Session</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.values(allUsers).map(user => {
                            let time, sessionCount;
                            switch(period) {
                                case 'today':
                                    time = getTodayTime(user);
                                    sessionCount = user.sessions?.filter(s => s.date === new Date().toLocaleDateString()).length || 0;
                                    break;
                                case 'week':
                                    time = getWeekTime(user);
                                    const thisWeek = getWeekKey(new Date());
                                    sessionCount = user.sessions?.filter(s => {
                                        const sessionDate = new Date(s.startTime || s.date);
                                        return getWeekKey(sessionDate) === thisWeek;
                                    }).length || 0;
                                    break;
                                case 'allTime':
                                    time = user.totalTimeSpent;
                                    sessionCount = user.sessions?.length || 0;
                                    break;
                            }
                            
                            return `
                                <tr style="border-bottom: 1px solid var(--color-border);">
                                    <td style="padding: var(--space-12); border: 1px solid var(--color-border);">${user.avatar} ${user.username}</td>
                                    <td style="padding: var(--space-12); text-align: center; border: 1px solid var(--color-border);">${formatTime(time)}</td>
                                    <td style="padding: var(--space-12); text-align: center; border: 1px solid var(--color-border);">${sessionCount}</td>
                                    ${period === 'allTime' ? `<td style="padding: var(--space-12); text-align: center; border: 1px solid var(--color-border);">${formatTime(getAverageSessionDuration(user))}</td>` : ''}
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            table.innerHTML += tableHTML;
            return table;
        }
        
        // Parent Access Functions
        function requestParentAccess() {
            const now = Date.now();
            if (parentLockoutTime > now) {
                const remaining = Math.ceil((parentLockoutTime - now) / 1000);
                alert(`Too many failed attempts. Please wait ${remaining} seconds before trying again.`);
                return;
            }
            
            showPasswordModal();
        }
        
        function showPasswordModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--color-surface);
                    border-radius: var(--radius-lg);
                    padding: var(--space-32);
                    text-align: center;
                    box-shadow: var(--shadow-lg);
                    max-width: 400px;
                    width: 90%;
                ">
                    <h2 style="color: var(--color-primary); margin-bottom: var(--space-16);">üîí Parent Dashboard</h2>
                    <p style="margin-bottom: var(--space-24); color: var(--color-text-secondary);">This area is for parents only.<br>Please enter the password:</p>
                    
                    <input type="password" id="parent-password" placeholder="Enter password" style="
                        width: 100%;
                        padding: var(--space-12);
                        font-size: var(--font-size-lg);
                        border: 2px solid var(--color-border);
                        border-radius: var(--radius-base);
                        margin-bottom: var(--space-16);
                        text-align: center;
                    ">
                    
                    <div id="password-error" style="color: var(--color-error); margin-bottom: var(--space-16); min-height: 20px;"></div>
                    
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="closePasswordModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="validateParentPassword()">Enter</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('parent-password').focus();
            
            // Add enter key support
            document.getElementById('parent-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    validateParentPassword();
                }
            });
            
            window.currentPasswordModal = modal;
        }
        
        function validateParentPassword() {
            const input = document.getElementById('parent-password');
            const password = input.value;
            const errorDiv = document.getElementById('password-error');
            
            if (password === PARENT_PASSWORD) {
                parentAccessGranted = true;
                parentFailedAttempts = 0;
                closePasswordModal();
                showParentDashboard();
            } else {
                parentFailedAttempts++;
                errorDiv.textContent = `Incorrect password. Attempts: ${parentFailedAttempts}/3`;
                input.value = '';
                input.focus();
                
                if (parentFailedAttempts >= 3) {
                    parentLockoutTime = Date.now() + 30000; // 30 seconds lockout
                    errorDiv.textContent = 'Too many attempts. Locked for 30 seconds.';
                    setTimeout(() => {
                        closePasswordModal();
                    }, 2000);
                }
            }
        }
        
        function closePasswordModal() {
            if (window.currentPasswordModal) {
                document.body.removeChild(window.currentPasswordModal);
                window.currentPasswordModal = null;
            }
        }
        
        function exitParentView() {
            parentAccessGranted = false;
            showUserScreen();
        }
        
        function exportTimeReport() {
            const data = {
                exportDate: new Date().toISOString(),
                users: Object.values(allUsers).map(user => ({
                    username: user.username,
                    todayTime: getTodayTime(user),
                    weekTime: getWeekTime(user),
                    totalTime: user.totalTimeSpent,
                    sessionCount: user.sessions?.length || 0,
                    averageSession: getAverageSessionDuration(user),
                    sessions: user.sessions?.map(session => ({
                        date: session.date,
                        duration: session.timeSpent,
                        mode: session.mode,
                        questionsAnswered: session.questionsAnswered,
                        correct: session.correct
                    })) || []
                }))
            };
            
            // Create CSV format
            let csv = 'Username,Date,Start Time,End Time,Duration (seconds),Mode,Questions Answered,Correct\n';
            
            Object.values(allUsers).forEach(user => {
                user.sessions?.forEach(session => {
                    const startTime = session.startTime ? new Date(session.startTime).toLocaleTimeString() : 'N/A';
                    const endTime = session.endTime ? new Date(session.endTime).toLocaleTimeString() : 'N/A';
                    csv += `${user.username},${session.date},${startTime},${endTime},${session.timeSpent || 0},${session.mode},${session.questionsAnswered || 0},${session.correct || 0}\n`;
                });
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `time_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // ============================================
            // CRITICAL FIX: CREATE NEW USER BUTTON
            // ============================================
            console.log('üîß Setting up Create New User button...');
            
            const createNewUserBtn = document.getElementById('createNewUserBtn');
            console.log('üîç Create New User button element:', createNewUserBtn);
            
            if (!createNewUserBtn) {
                console.error('‚ùå CRITICAL ERROR: Create New User button not found!');
                alert('CRITICAL ERROR: Button not found! Please refresh the page.');
                return;
            }
            
            console.log('‚úÖ Create New User button found, adding event listener...');
            
            // Remove any existing listeners first
            createNewUserBtn.replaceWith(createNewUserBtn.cloneNode(true));
            const freshBtn = document.getElementById('createNewUserBtn');
            
            freshBtn.addEventListener('click', function(event) {
                console.log('üéØ CREATE NEW USER BUTTON CLICKED!');
                console.log('üìç Event triggered:', event);
                console.log('üìç Button element:', this);
                
                // Prevent any default behavior
                event.preventDefault();
                event.stopPropagation();
                
                console.log('üìû Calling showCreateUserModal()...');
                showCreateUserModal();
            });
            
            // Also add a direct onclick as backup
            freshBtn.onclick = function(event) {
                console.log('üéØ BACKUP ONCLICK TRIGGERED!');
                event.preventDefault();
                showCreateUserModal();
            };
            
            console.log('‚úÖ Event listeners added successfully!');
            console.log('üîç Button onclick:', freshBtn.onclick);
            console.log('üîç Button addEventListener count: Event listener added');
            
            // TEST THE BUTTON IMMEDIATELY
            console.log('üß™ Testing button accessibility...');
            console.log('üîç Button disabled?', freshBtn.disabled);
            console.log('üîç Button display:', getComputedStyle(freshBtn).display);
            console.log('üîç Button visibility:', getComputedStyle(freshBtn).visibility);
            console.log('üîç Button pointer-events:', getComputedStyle(freshBtn).pointerEvents);
            
            // ============================================
            // CONFIRM CREATE USER BUTTON
            // ============================================
            console.log('üîß Setting up Confirm Create User button...');
            
            const confirmCreateUserBtn = document.getElementById('confirmCreateUser');
            console.log('üîç Confirm button found:', confirmCreateUserBtn);
            
            if (confirmCreateUserBtn) {
                confirmCreateUserBtn.addEventListener('click', function() {
                    console.log('‚úÖ Confirm Create User clicked!');
                    
                    const username = document.getElementById('newUsername').value.trim();
                    const errorDiv = document.getElementById('username-error');
                    
                    console.log('üîç Username entered:', username);
                    
                    // Validation
                    if (!username) {
                        console.log('‚ùå Validation failed: No username');
                        errorDiv.textContent = 'Please enter a username';
                        errorDiv.style.display = 'block';
                        alert('Please enter a username!');
                        return;
                    }
                    
                    if (username.length < 2) {
                        console.log('‚ùå Validation failed: Username too short');
                        errorDiv.textContent = 'Username must be at least 2 characters';
                        errorDiv.style.display = 'block';
                        alert('Username must be at least 2 characters!');
                        return;
                    }
                    
                    // Check for duplicates
                    const users = allUsers;
                    if (users[username]) {
                        console.log('‚ùå Validation failed: Username exists');
                        errorDiv.textContent = 'Username already exists. Please choose a different name.';
                        errorDiv.style.display = 'block';
                        alert('Username already exists! Please choose a different name.');
                        return;
                    }
                    
                    // Get selected avatar
                    const selectedAvatarElement = document.querySelector('.avatar-option.selected');
                    const avatar = selectedAvatarElement ? selectedAvatarElement.dataset.emoji : 'üöÄ';
                    
                    console.log('‚úÖ Validation passed! Creating user:', username, avatar);
                    
                    // Create user
                    const newUser = createNewUser(username, avatar);
                    console.log('‚úÖ User created:', newUser);
                    
                    // Close modal
                    closeCreateUserModal();
                    console.log('‚úÖ Modal closed');
                    
                    // Refresh user list
                    populateUserList();
                    console.log('‚úÖ User list refreshed');
                    
                    // Show welcome screen
                    showWelcome();
                    console.log('‚úÖ Welcome screen shown');
                    
                    // Show success message
                    alert(`User "${username}" created successfully! üéâ`);
                    console.log('üéâ USER CREATION COMPLETE!');
                });
            }
            
            // ============================================
            // CANCEL CREATE USER BUTTON
            // ============================================
            console.log('üîß Setting up Cancel button...');
            
            const cancelCreateUserBtn = document.getElementById('cancelCreateUser');
            console.log('üîç Cancel button found:', cancelCreateUserBtn);
            
            if (cancelCreateUserBtn) {
                cancelCreateUserBtn.addEventListener('click', function() {
                    console.log('üö´ Cancel button clicked');
                    closeCreateUserModal();
                });
            }
            
            // ============================================
            // MODAL CLICK OUTSIDE TO CLOSE
            // ============================================
            const modal = document.getElementById('createUserModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        console.log('üö´ Clicked outside modal, closing...');
                        closeCreateUserModal();
                    }
                });
            }
            
            // ============================================
            // ENTER KEY IN USERNAME INPUT
            // ============================================
            const usernameInput = document.getElementById('newUsername');
            if (usernameInput) {
                usernameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        console.log('‚èé Enter pressed in username input');
                        document.getElementById('confirmCreateUser').click();
                    }
                });
            }
            
            // Username input validation
            const newUsernameInput = document.getElementById('newUsername');
            if (newUsernameInput) {
                newUsernameInput.addEventListener('input', function() {
                    const errorDiv = document.getElementById('username-error');
                    if (errorDiv.style.display !== 'none') {
                        errorDiv.style.display = 'none';
                    }
                });
                
                newUsernameInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        document.getElementById('confirmCreateUser').click();
                    }
                });
            }
            
            // ============================================
            // INITIALIZE AVATAR SELECTION WITH LOGGING
            // ============================================
            console.log('üéÜ Initializing avatar selection...');
            renderAvatarSelection();
            
            // ============================================
            // INITIALIZE USER SYSTEM
            // ============================================
            console.log('üë• Initializing user system...');
            initializeUserSystem();
            
            // Update leaderboards on load
            updateLeaderboards();
            
            // ============================================
            // FINAL TESTING VERIFICATION
            // ============================================
            setTimeout(() => {
                console.log('üß™ RUNNING FINAL VERIFICATION TESTS...');
                
                // Test 1: Button exists in DOM
                const btn = document.getElementById('createNewUserBtn');
                console.log('‚úÖ Test 1 - Button exists:', !!btn);
                
                // Test 2: Button is clickable
                console.log('‚úÖ Test 2 - Button clickable:', btn && !btn.disabled);
                
                // Test 3: Modal exists
                const modal = document.getElementById('createUserModal');
                console.log('‚úÖ Test 3 - Modal exists:', !!modal);
                
                // Test 4: Username input exists
                const input = document.getElementById('newUsername');
                console.log('‚úÖ Test 4 - Username input exists:', !!input);
                
                // Test 5: Avatar options exist
                const avatars = document.querySelectorAll('.avatar-option');
                console.log('‚úÖ Test 5 - Avatar options count:', avatars.length);
                
                // Test 6: Confirm button exists
                const confirmBtn = document.getElementById('confirmCreateUser');
                console.log('‚úÖ Test 6 - Confirm button exists:', !!confirmBtn);
                
                console.log('üéâ VERIFICATION COMPLETE - All systems ready!');
                console.log('üìù Instructions: Click "Create New User" button to test');
                
                // Auto-test the flow after page load
                console.log('ü§ñ Running automatic test in 2 seconds...');
                setTimeout(() => {
                    testCreateUserFlow();
                }, 2000);
            }, 1000);
            
            // ============================================
            // TESTING FUNCTIONS
            // ============================================
            window.testCreateUserFlow = function() {
                console.log('üß™ TESTING CREATE USER FLOW...');
                
                const btn = document.getElementById('createNewUserBtn');
                if (!btn) {
                    console.error('‚ùå FAIL: Button not found!');
                    return;
                }
                
                console.log('‚úÖ PASS: Button exists');
                
                // Simulate click
                console.log('üîò Simulating button click...');
                btn.click();
                
                // Check if modal appeared
                setTimeout(() => {
                    const modal = document.getElementById('createUserModal');
                    const isVisible = modal && (modal.style.display === 'flex' || modal.classList.contains('visible'));
                    
                    if (isVisible) {
                        console.log('‚úÖ PASS: Modal is visible!');
                        alert('‚úÖ SUCCESS: Create User Modal is working! You can now create users.');
                    } else {
                        console.error('‚ùå FAIL: Modal not visible after click!');
                        alert('‚ùå FAIL: Modal not showing. Please check the console for errors.');
                    }
                }, 500);
            };
            
            window.testModalVisibility = function() {
                const modal = document.getElementById('createUserModal');
                if (!modal) {
                    alert('Modal element not found!');
                    return;
                }
                
                console.log('Modal current state:', {
                    display: modal.style.display,
                    visibility: getComputedStyle(modal).visibility,
                    zIndex: modal.style.zIndex,
                    classes: modal.className
                });
                
                alert('Modal state logged to console. Check developer tools.');
            };
            
            window.hideTesting = function() {
                document.getElementById('testing-panel').style.display = 'none';
            };
            
            // Keyboard shortcut for parent access (triple P)
            document.addEventListener('keydown', function(e) {
                if (e.key.toLowerCase() === 'p') {
                    keyPressCount++;
                    
                    if (keyPressTimer) {
                        clearTimeout(keyPressTimer);
                    }
                    
                    keyPressTimer = setTimeout(() => {
                        keyPressCount = 0;
                    }, 2000);
                    
                    if (keyPressCount >= 3) {
                        keyPressCount = 0;
                        requestParentAccess();
                    }
                }
            });
            
            // Close modal when clicking outside
            document.addEventListener('click', function(e) {
                const modal = document.getElementById('createUserModal');
                if (e.target === modal) {
                    closeCreateUserModal();
                }
            });
        });
    </script>
</body>
</html>