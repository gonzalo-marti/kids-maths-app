<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperHero Maths - Reliable Edition</title>
    <style>
        /* Design System CSS */
        :root {
            /* Primitive Color Tokens */
            --color-white: rgba(255, 255, 255, 1);
            --color-black: rgba(0, 0, 0, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-gray-400: rgba(119, 124, 124, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-brown-600: rgba(94, 82, 64, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-teal-300: rgba(50, 184, 198, 1);
            --color-teal-400: rgba(45, 166, 178, 1);
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-red-400: rgba(255, 84, 89, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-orange-400: rgba(230, 129, 97, 1);
            --color-orange-500: rgba(168, 75, 47, 1);

            /* RGB versions for opacity control */
            --color-brown-600-rgb: 94, 82, 64;
            --color-teal-500-rgb: 33, 128, 141;
            --color-slate-900-rgb: 19, 52, 59;
            --color-slate-500-rgb: 98, 108, 113;
            --color-red-500-rgb: 192, 21, 47;
            --color-red-400-rgb: 255, 84, 89;

            /* Background color tokens */
            --color-bg-1: rgba(59, 130, 246, 0.08);
            --color-bg-2: rgba(245, 158, 11, 0.08);
            --color-bg-3: rgba(34, 197, 94, 0.08);
            --color-bg-4: rgba(239, 68, 68, 0.08);

            /* Semantic Color Tokens */
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-primary-active: var(--color-teal-700);
            --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
            --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
            --color-border: rgba(var(--color-brown-600-rgb), 0.2);
            --color-btn-primary-text: var(--color-cream-50);
            --color-error: var(--color-red-500);
            --color-success: var(--color-teal-500);

            /* Typography */
            --font-family-base: "Arial", sans-serif;
            --font-size-sm: 12px;
            --font-size-base: 14px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            --font-size-2xl: 24px;
            --font-size-3xl: 28px;
            --font-size-4xl: 36px;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-bold: 600;

            /* Spacing */
            --space-4: 4px;
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-20: 20px;
            --space-24: 24px;
            --space-32: 32px;

            /* Border Radius */
            --radius-base: 8px;
            --radius-lg: 12px;

            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
        }

        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-base);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text);
        }

        .app-container {
            width: 100%;
            max-width: 800px;
            margin: var(--space-20);
        }

        .screen {
            display: none;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-32);
            box-shadow: var(--shadow-md);
            text-align: center;
        }

        .screen.active {
            display: block;
        }

        h1 {
            font-size: var(--font-size-4xl);
            color: var(--color-primary);
            margin-bottom: var(--space-16);
        }

        h2 {
            font-size: var(--font-size-3xl);
            color: var(--color-primary);
            margin-bottom: var(--space-24);
        }

        .subtitle {
            font-size: var(--font-size-lg);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-32);
        }

        /* Button Styles */
        .btn {
            padding: var(--space-12) var(--space-24);
            border: none;
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px;
            min-width: 120px;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--color-primary);
            color: var(--color-btn-primary-text);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: var(--color-secondary);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--color-secondary-hover);
        }

        .button-group {
            display: flex;
            gap: var(--space-12);
            justify-content: center;
            flex-wrap: wrap;
            margin: var(--space-16) 0;
        }

        /* User Selection */
        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-16);
            margin-bottom: var(--space-32);
        }

        .user-card {
            background: var(--color-bg-1);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
        }

        .user-avatar {
            font-size: var(--font-size-4xl);
            margin-bottom: var(--space-12);
        }

        .user-name {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-text);
            margin-bottom: var(--space-8);
        }

        .user-stats {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--color-surface);
            padding: var(--space-32);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            max-width: 500px;
            width: 90%;
        }

        .form-group {
            margin-bottom: var(--space-16);
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-8);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-sm);
        }

        .form-control {
            width: 100%;
            padding: var(--space-12);
            font-size: var(--font-size-base);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-base);
            background: var(--color-surface);
            color: var(--color-text);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .avatar-selection {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-8);
            margin-bottom: var(--space-16);
        }

        .avatar-option {
            background: var(--color-secondary);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-12);
            font-size: var(--font-size-2xl);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar-option:hover {
            border-color: var(--color-primary);
            background: var(--color-secondary-hover);
        }

        .avatar-option.selected {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Question Screen */
        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-24);
            padding: var(--space-16);
            background: var(--color-bg-2);
            border-radius: var(--radius-base);
            flex-wrap: wrap;
            gap: var(--space-16);
        }

        .timer {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
        }

        .timer.warning {
            color: var(--color-orange-500);
        }

        .timer.danger {
            color: var(--color-red-500);
        }

        .question-container {
            background: var(--color-bg-1);
            border-radius: var(--radius-lg);
            padding: var(--space-24);
            margin-bottom: var(--space-24);
            border: 2px solid var(--color-border);
        }

        .question-text {
            font-size: var(--font-size-xl);
            margin-bottom: var(--space-24);
            color: var(--color-text);
        }

        .answer-input {
            width: 100%;
            max-width: 300px;
            padding: var(--space-12) var(--space-16);
            font-size: var(--font-size-lg);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-base);
            margin-bottom: var(--space-16);
            text-align: center;
            background: var(--color-surface);
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .feedback {
            margin: var(--space-16) 0;
            padding: var(--space-16);
            border-radius: var(--radius-base);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
        }

        .feedback.correct {
            background: rgba(var(--color-teal-500-rgb), 0.1);
            color: var(--color-success);
            border: 2px solid var(--color-success);
        }

        .feedback.incorrect {
            background: rgba(var(--color-red-500-rgb), 0.1);
            color: var(--color-error);
            border: 2px solid var(--color-error);
        }

        /* Error Display */
        .error-display {
            display: none;
            background: rgba(var(--color-red-500-rgb), 0.1);
            color: var(--color-error);
            border: 2px solid var(--color-error);
            border-radius: var(--radius-base);
            padding: var(--space-16);
            margin: var(--space-16) 0;
            font-weight: var(--font-weight-medium);
        }

        /* Leaderboard */
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-12);
            margin-bottom: var(--space-8);
            background: var(--color-bg-3);
            border-radius: var(--radius-base);
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: var(--space-12);
        }

        .rank {
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                margin: var(--space-12);
            }

            .screen {
                padding: var(--space-24);
            }

            h1 {
                font-size: var(--font-size-3xl);
            }

            .user-list {
                grid-template-columns: 1fr;
            }

            .progress-info {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Error Display -->
        <div id="errorDisplay" class="error-display"></div>

        <!-- User Selection Screen -->
        <div class="screen active" id="userScreen">
            <h1>🦸 SuperHero Maths</h1>
            <p class="subtitle">Choose your profile to start learning!</p>
            
            <div id="userList" class="user-list">
                <!-- Users will be populated here -->
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" id="createUserBtn">➕ Create New User</button>
                <button class="btn btn-secondary" id="parentViewBtn">👨‍👩‍👧‍👦 Parent View</button>
            </div>
        </div>

        <!-- Practice Screen -->
        <div class="screen" id="practiceScreen">
            <div class="progress-info">
                <div id="questionNumber">Question 1</div>
                <div id="scoreDisplay">Score: 0/0</div>
                <div class="timer" id="timerDisplay"></div>
            </div>
            
            <div class="question-container">
                <div class="question-text" id="questionText">Loading question...</div>
                
                <input type="text" class="answer-input" id="answerInput" placeholder="Type your answer...">
                
                <div class="button-group">
                    <button class="btn btn-primary" id="submitBtn" disabled>Submit Answer</button>
                </div>
                
                <div id="feedbackContainer"></div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-secondary" onclick="backToMenu()">🏠 Back to Menu</button>
            </div>
        </div>

        <!-- Leaderboard Screen -->
        <div class="screen" id="leaderboardScreen">
            <h2>🏆 Leaderboard</h2>
            <div id="leaderboardList">
                <!-- Leaderboard will be populated here -->
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="backToMenu()">🏠 Back to Menu</button>
            </div>
        </div>

        <!-- Parent Dashboard -->
        <div class="screen" id="parentScreen">
            <h2>👨‍👩‍👧‍👦 Parent Dashboard</h2>
            <div id="parentContent">
                <!-- Parent dashboard content -->
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="backToMenu()">🏠 Back to Menu</button>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="modal">
        <div class="modal-content">
            <h2>Create New User</h2>
            <div class="form-group">
                <label class="form-label" for="usernameInput">Name:</label>
                <input type="text" class="form-control" id="usernameInput" placeholder="Enter your name" maxlength="20">
            </div>
            <div class="form-group">
                <label class="form-label">Choose your avatar:</label>
                <div class="avatar-selection" id="avatarSelection">
                    <!-- Avatars will be populated here -->
                </div>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" id="confirmCreateBtn">Create</button>
                <button class="btn btn-secondary" id="cancelCreateBtn">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        'use strict';

        // Main initialization function - ASYNC
        async function initializeApp() {
            console.log('Starting app initialization...');
            
            // Firebase Configuration
            const firebaseConfig = {
                apiKey: "AIzaSyDeCXHxMolX3VxoDiIndMXjEU_EQJ2G_HI",
                authDomain: "superheromaths.firebaseapp.com",
                projectId: "superheromaths",
                storageBucket: "superheromaths.firebasestorage.app",
                messagingSenderId: "695354044143",
                appId: "1:695354044143:web:e78e885474bd1b0693b51a"
            };
            
            // STEP 1: Load Firebase modules (AWAIT completion)
            try {
                const { initializeApp: initFB } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
                const { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, query, orderBy } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                // STEP 2: Initialize Firebase
                const app = initFB(firebaseConfig);
                window.db = getFirestore(app);
                window.firestoreFunctions = { collection, doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, query, orderBy };
                
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization error:', error);
                console.log('App will work in offline mode with localStorage');
                window.db = null;
            }
            
            // STEP 3: Set up UI and event listeners (AFTER Firebase loads)
            setupButtons();
            setupEventListeners();
            await loadUsers();
            
            console.log('App initialization complete!');
        }
        
        // Global State
        let users = {};
        let currentUser = null;
        let selectedAvatar = '🚀';
        let currentQuestion = null;
        let score = 0;
        let questionCount = 0;
        let timeRemaining = 0;
        let timerInterval = null;
        
        // Predefined names and avatars
        const names = ['Nacho', 'Javi', 'Gonza', 'Ignacio', 'Javier', 'Gonzalo', 'Steven', 'Harry', 'Noah', 'Aiden', 'Liam', 'Rafa', 'Sergei', 'Ayana', 'Ramon', 'Iñigo', 'Luis', 'Jaime', 'Thiago', 'Leo', 'Felipe', 'Enrique', 'Sofia', 'Flap', 'Ethan', 'Santi', 'William', 'Kaiser', 'Iñaki', 'Cristina', 'Loreto', 'Macarena', 'Ray', 'Nina', 'Ana', 'Maria', 'Sheina', 'Paloma', 'Totu', 'Gaby'];
        const avatars = ['🚀', '⚽', '🎨', '🌟', '🎮', '🦄', '🌈', '🎯', '⭐', '🔥', '💫', '🎪', '🎭', '🎬', '🎤', '🏀'];
        
        // Simple question bank
        const questions = [
            { question: "What is 5 + 3?", answer: 8 },
            { question: "What is 12 - 4?", answer: 8 },
            { question: "What is 6 × 2?", answer: 12 },
            { question: "What is 15 ÷ 3?", answer: 5 },
            { question: "What is 9 + 7?", answer: 16 },
            { question: "What is 20 - 8?", answer: 12 },
            { question: "What is 4 × 5?", answer: 20 },
            { question: "What is 24 ÷ 4?", answer: 6 },
            { question: "What is 13 + 9?", answer: 22 },
            { question: "What is 18 - 6?", answer: 12 }
        ];
        
        // Error handling function
        function showError(message) {
            const errorDiv = document.getElementById('errorDisplay');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Setup buttons
        function setupButtons() {
            console.log('Setting up buttons...');
            
            // Create User button
            const createBtn = document.getElementById('createUserBtn');
            if (createBtn) {
                createBtn.addEventListener('click', showCreateUserModal);
                console.log('Create button listener attached');
            } else {
                console.error('Create button not found!');
            }
            
            // Parent View button
            const parentBtn = document.getElementById('parentViewBtn');
            if (parentBtn) {
                parentBtn.addEventListener('click', showParentPasswordModal);
                console.log('Parent button listener attached');
            } else {
                console.error('Parent button not found!');
            }
            
            // Modal buttons
            const confirmBtn = document.getElementById('confirmCreateBtn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', createUser);
            }
            
            const cancelBtn = document.getElementById('cancelCreateBtn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeCreateUserModal);
            }
        }

        // Setup other event listeners
        function setupEventListeners() {
            // Close modal on outside click
            const modal = document.getElementById('createUserModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeCreateUserModal();
                    }
                });
            }
            
            // Enter key in username input
            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput) {
                usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        createUser();
                    }
                });
            }
            
            // Submit button and answer input
            const submitBtn = document.getElementById('submitBtn');
            const answerInput = document.getElementById('answerInput');
            
            if (submitBtn && answerInput) {
                // Submit button click
                submitBtn.addEventListener('click', submitAnswer);
                
                // Answer input validation
                answerInput.addEventListener('input', function() {
                    const value = this.value.trim();
                    submitBtn.disabled = value === '';
                });
                
                // Enter key to submit
                answerInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !submitBtn.disabled) {
                        submitAnswer();
                    }
                });
                
                console.log('Answer input and submit button setup complete');
            } else {
                console.error('Submit button or answer input not found!');
            }
        }

        // Firebase functions with fallback
        async function saveUser(username, userData) {
            try {
                if (window.db && window.firestoreFunctions) {
                    const { doc, setDoc } = window.firestoreFunctions;
                    await setDoc(doc(window.db, 'users', username), userData);
                    console.log('User saved to Firebase:', username);
                } else {
                    // Fallback to in-memory storage
                    users[username] = userData;
                    console.log('User saved to memory:', username);
                }
            } catch (error) {
                console.error('Error saving user:', error);
                showError('Error saving user: ' + error.message);
                // Fallback to in-memory storage
                users[username] = userData;
            }
        }
        
        async function loadUsers() {
            console.log('Loading users...');
            let loadedUsers = {};
            
            try {
                if (window.db && window.firestoreFunctions) {
                    // Load from Firebase
                    const { collection, getDocs } = window.firestoreFunctions;
                    const snapshot = await getDocs(collection(window.db, 'users'));
                    snapshot.forEach(doc => {
                        loadedUsers[doc.id] = doc.data();
                    });
                    console.log('Loaded users from Firebase:', Object.keys(loadedUsers).length);
                } else {
                    // Use in-memory storage
                    loadedUsers = users;
                    console.log('Using in-memory users:', Object.keys(loadedUsers).length);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                loadedUsers = users;
            }
            
            users = loadedUsers;
            updateUserList();
        }
        
        // User creation modal functions
        function showCreateUserModal() {
            console.log('Opening create user modal');
            const modal = document.getElementById('createUserModal');
            if (!modal) {
                console.error('Modal not found!');
                return;
            }
            modal.classList.add('show');
            
            // Clear form
            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput) {
                usernameInput.value = '';
                usernameInput.focus();
            }
            
            // Setup avatars
            renderAvatarGrid();
        }
        
        function closeCreateUserModal() {
            const modal = document.getElementById('createUserModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }
        
        function renderAvatarGrid() {
            const grid = document.getElementById('avatarSelection');
            if (!grid) return;
            
            grid.innerHTML = '';
            avatars.forEach((emoji, index) => {
                const div = document.createElement('div');
                div.className = 'avatar-option';
                if (index === 0) div.classList.add('selected');
                div.textContent = emoji;
                div.addEventListener('click', function() {
                    document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedAvatar = emoji;
                });
                grid.appendChild(div);
            });
            selectedAvatar = avatars[0];
        }
        
        async function createUser() {
            const username = document.getElementById('usernameInput').value.trim();
            
            if (!username) {
                alert('Please enter a name');
                return;
            }
            
            if (username.length < 2) {
                alert('Name must be at least 2 characters');
                return;
            }
            
            if (users[username]) {
                alert('Username already exists');
                return;
            }
            
            try {
                const userData = {
                    username: username,
                    avatar: selectedAvatar,
                    totalPoints: 0,
                    totalCorrect: 0,
                    totalAttempted: 0,
                    createdAt: new Date(),
                    lastActive: new Date()
                };
                
                await saveUser(username, userData);
                closeCreateUserModal();
                alert(`Welcome, ${username}! 🎉`);
                await loadUsers();
                
                console.log('User created successfully:', username);
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Error creating user: ' + error.message);
            }
        }
        
        function updateUserList() {
            const userList = document.getElementById('userList');
            if (!userList) {
                console.error('User list container not found');
                return;
            }
            
            userList.innerHTML = '';
            
            if (Object.keys(users).length === 0) {
                userList.innerHTML = '<p style="text-align: center; color: #666;">No users yet. Create one to get started!</p>';
                return;
            }
            
            Object.values(users).forEach(user => {
                const card = document.createElement('button');
                card.className = 'user-card';
                card.innerHTML = `
                    <div class="user-avatar">${user.avatar}</div>
                    <div class="user-name">${user.username}</div>
                    <div class="user-stats">Points: ${user.totalPoints || 0}</div>
                `;
                card.addEventListener('click', () => selectUser(user.username));
                userList.appendChild(card);
            });
        }
        
        function selectUser(username) {
            console.log('User selected:', username);
            // Store current user in memory
            window.currentUserName = username;
            currentUser = users[username];
            // Navigate to main app (implement this)
            alert(`Selected user: ${username}\n\nApp features coming next!`);
        }
        
        // Practice mode functions
        function startPractice() {
            showScreen('practiceScreen');
            score = 0;
            questionCount = 0;
            nextQuestion();
        }
        
        function nextQuestion() {
            currentQuestion = questions[Math.floor(Math.random() * questions.length)];
            questionCount++;
            
            document.getElementById('questionNumber').textContent = `Question ${questionCount}`;
            document.getElementById('questionText').textContent = currentQuestion.question;
            document.getElementById('scoreDisplay').textContent = `Score: ${score}/${questionCount - 1}`;
            
            const answerInput = document.getElementById('answerInput');
            if (answerInput) {
                answerInput.value = '';
                answerInput.disabled = false;
                answerInput.focus();
            }
            
            const submitBtn = document.getElementById('submitBtn');
            if (submitBtn) {
                submitBtn.style.display = 'block';
                submitBtn.disabled = true;
            }
            
            // Clear feedback
            document.getElementById('feedbackContainer').innerHTML = '';
        }
        
        function submitAnswer() {
            const userAnswer = parseFloat(document.getElementById('answerInput').value);
            const correct = userAnswer === currentQuestion.answer;
            
            if (correct) {
                score++;
            }
            
            // Update user stats
            if (currentUser) {
                currentUser.totalAttempted++;
                if (correct) {
                    currentUser.totalCorrect++;
                    currentUser.totalPoints = (currentUser.totalPoints || 0) + 10;
                }
                
                // Save updated user data
                saveUser(currentUser.username, currentUser);
            }
            
            // Show feedback
            const feedbackContainer = document.getElementById('feedbackContainer');
            const feedback = document.createElement('div');
            feedback.className = `feedback ${correct ? 'correct' : 'incorrect'}`;
            feedback.innerHTML = correct ? 
                '✅ Correct! Well done!' : 
                `❌ Incorrect. The answer is ${currentQuestion.answer}`;
            
            feedbackContainer.innerHTML = '';
            feedbackContainer.appendChild(feedback);
            
            // Update display
            document.getElementById('scoreDisplay').textContent = `Score: ${score}/${questionCount}`;
            
            // Next question after delay
            setTimeout(() => {
                nextQuestion();
            }, 2000);
        }
        
        // Navigation functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }
        
        function backToMenu() {
            showScreen('userScreen');
        }
        
        // Parent view function
        function showParentPasswordModal() {
            const password = prompt('🔒 Enter parent password:');
            if (password === '260283') {
                alert('Parent Dashboard\n\n(Features will be implemented next)');
            } else if (password !== null) {
                alert('Incorrect password');
            }
        }
        
        function showParentDashboard() {
            showScreen('parentScreen');
            updateParentDashboard();
        }
        
        function updateParentDashboard() {
            const parentContent = document.getElementById('parentContent');
            if (!parentContent) return;
            
            let html = '<h3>User Statistics</h3>';
            
            if (Object.keys(users).length === 0) {
                html += '<p>No users to display.</p>';
            } else {
                Object.values(users).forEach(user => {
                    const accuracy = user.totalAttempted > 0 ? 
                        Math.round((user.totalCorrect / user.totalAttempted) * 100) : 0;
                    
                    html += `
                        <div class="leaderboard-item">
                            <div class="player-info">
                                <span class="user-avatar">${user.avatar}</span>
                                <span>${user.username}</span>
                            </div>
                            <div>
                                ${user.totalCorrect}/${user.totalAttempted} (${accuracy}%) | ${user.totalPoints || 0} pts
                            </div>
                        </div>
                    `;
                });
            }
            
            parentContent.innerHTML = html;
        }
        
        // Make functions global for onclick handlers
        window.backToMenu = backToMenu;
        
        // STEP 4: Start initialization when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            // DOM already loaded
            initializeApp();
        }
        
        console.log('🎉 SuperHero Maths App - Version 2.2.1 - Async Init Fixed (Thanks to Gonzalo\'s Friend!) - Loaded Successfully!');
    </script>
</body>
</html>